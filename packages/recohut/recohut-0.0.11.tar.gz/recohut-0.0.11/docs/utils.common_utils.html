---

title: Common utils


keywords: fastai
sidebar: home_sidebar

summary: "A collection of utilities often used."
description: "A collection of utilities often used."
nb_path: "nbs/utils/utils.common_utils.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/utils/utils.common_utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Download">Download<a class="anchor-link" href="#Download"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="wget_download" class="doc_header"><code>wget_download</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>wget_download</code>(<strong><code>url</code></strong>, <strong><code>savepath</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="download_url" class="doc_header"><code>download_url</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L35" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>download_url</code>(<strong><code>url</code></strong>:<code>str</code>, <strong><code>folder</code></strong>:<code>str</code>, <strong><code>log</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Downloads the content of an URL to a specific folder.
Args:
    url (string): The url.
    folder (string): The folder.
    log (bool, optional): If :obj:<code>False</code>, will not print anything to the
        console. (default: :obj:<code>True</code>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">download_url</span><span class="p">(</span><span class="s1">&#39;https://files.grouplens.org/datasets/movielens/ml-1m.zip&#39;</span><span class="p">,</span>
             <span class="s1">&#39;./data/bronze&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Downloading https://files.grouplens.org/datasets/movielens/ml-1m.zip
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;./data/bronze/ml-1m.zip&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>tree ./data
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>./data
└── bronze
    └── ml-1m.zip

1 directory, 1 file
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>tree --du -h -C ./data
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-intense-fg ansi-bold">./data</span>
├── [ 24M]  <span class="ansi-blue-intense-fg ansi-bold">bronze</span>
│   └── [ 24M]  <span class="ansi-blue-intense-fg ansi-bold">ml-1m</span>
│       ├── [167K]  movies.dat
│       ├── [ 23M]  ratings.dat
│       ├── [5.4K]  README
│       └── [131K]  users.dat
└── [3.0M]  <span class="ansi-blue-intense-fg ansi-bold">silver</span>
    └── [3.0M]  <span class="ansi-blue-intense-fg ansi-bold">ml-1m_min_rating0-min_uc5-min_sc5-splitleave_one_out</span>
        └── [3.0M]  dataset.pkl

  27M used in 4 directories, 5 files
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Extract">Extract<a class="anchor-link" href="#Extract"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_tar" class="doc_header"><code>extract_tar</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L72" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_tar</code>(<strong><code>path</code></strong>:<code>str</code>, <strong><code>folder</code></strong>:<code>str</code>, <strong><code>mode</code></strong>:<code>str</code>=<em><code>'r:gz'</code></em>, <strong><code>log</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Extracts a tar archive to a specific folder.
Args:
    path (string): The path to the tar archive.
    folder (string): The folder.
    mode (string, optional): The compression mode. (default: :obj:<code>"r:gz"</code>)
    log (bool, optional): If :obj:<code>False</code>, will not print anything to the
        console. (default: :obj:<code>True</code>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_zip" class="doc_header"><code>extract_zip</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L86" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_zip</code>(<strong><code>path</code></strong>:<code>str</code>, <strong><code>folder</code></strong>:<code>str</code>, <strong><code>log</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Extracts a zip archive to a specific folder.
Args:
    path (string): The path to the tar archive.
    folder (string): The folder.
    log (bool, optional): If :obj:<code>False</code>, will not print anything to the
        console. (default: :obj:<code>True</code>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_bz2" class="doc_header"><code>extract_bz2</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L99" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_bz2</code>(<strong><code>path</code></strong>:<code>str</code>, <strong><code>folder</code></strong>:<code>str</code>, <strong><code>log</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Extracts a bz2 archive to a specific folder.
Args:
    path (string): The path to the tar archive.
    folder (string): The folder.
    log (bool, optional): If :obj:<code>False</code>, will not print anything to the
        console. (default: :obj:<code>True</code>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_gz" class="doc_header"><code>extract_gz</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L114" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_gz</code>(<strong><code>path</code></strong>:<code>str</code>, <strong><code>folder</code></strong>:<code>str</code>, <strong><code>log</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Extracts a gz archive to a specific folder.
Args:
    path (string): The path to the tar archive.
    folder (string): The folder.
    log (bool, optional): If :obj:<code>False</code>, will not print anything to the
        console. (default: :obj:<code>True</code>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tabulate">Tabulate<a class="anchor-link" href="#Tabulate"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="print_result_as_table" class="doc_header"><code>print_result_as_table</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L129" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>print_result_as_table</code>(<strong><code>results</code></strong>, <strong><code>tag</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Print results as a table.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span><span class="s1">&#39;MF&#39;</span><span class="p">,</span> <span class="s1">&#39;MRR&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">35</span><span class="p">},</span>
           <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span><span class="s1">&#39;NCF&#39;</span><span class="p">,</span> <span class="s1">&#39;MRR&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;nDCG&#39;</span><span class="p">:</span><span class="o">.</span><span class="mi">25</span><span class="p">}]</span>

<span class="n">print_result_as_table</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--------------------------------------------------------------------------------
+------+------+-------+
|      | MF   |   NCF |
|------+------+-------|
| MRR  | 0.35 |  0.42 |
| nDCG | --   |  0.25 |
+------+------+-------+
--------------------------------------------------------------------------------
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Listing">Listing<a class="anchor-link" href="#Listing"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="list_files" class="doc_header"><code>list_files</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L149" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>list_files</code>(<strong><code>startpath</code></strong>)</p>
</blockquote>
<p>Util function to print the nested structure of a directory</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">list_files</span><span class="p">(</span><span class="s1">&#39;./sample_data&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>sample_data/
    README.md
    anscombe.json
    california_housing_train.csv
    california_housing_test.csv
    mnist_test.csv
    mnist_train_small.csv
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Deterministic">Deterministic<a class="anchor-link" href="#Deterministic"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="seed_everything" class="doc_header"><code>seed_everything</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L169" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>seed_everything</code>(<strong><code>seed</code></strong>=<em><code>40</code></em>)</p>
</blockquote>
<p>sets the random seed to establish deterministic behaviors</p>
<p>Args:
    seed (int): the random seed integer</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Mapping,-Masking,-and-Padding">Mapping, Masking, and Padding<a class="anchor-link" href="#Mapping,-Masking,-and-Padding"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="map_column" class="doc_header"><code>map_column</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L191" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>map_column</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>col_name</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Maps column values to integers.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_context" class="doc_header"><code>get_context</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L200" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_context</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>split</code></strong>:<code>str</code>, <strong><code>context_size</code></strong>:<code>int</code>=<em><code>120</code></em>, <strong><code>val_context_size</code></strong>:<code>int</code>=<em><code>5</code></em>, <strong><code>seed</code></strong>:<code>int</code>=<em><code>42</code></em>)</p>
</blockquote>
<p>Create a training / validation samples.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pad_arr" class="doc_header"><code>pad_arr</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L216" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pad_arr</code>(<strong><code>arr</code></strong>:<code>ndarray</code>, <strong><code>expected_size</code></strong>:<code>int</code>=<em><code>30</code></em>)</p>
</blockquote>
<p>Pad top of array when there is not enough history.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pad_list" class="doc_header"><code>pad_list</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L222" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pad_list</code>(<strong><code>list_integers</code></strong>, <strong><code>history_size</code></strong>:<code>int</code>, <strong><code>pad_val</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>mode</code></strong>=<em><code>'left'</code></em>)</p>
</blockquote>
<p>Pad list from left or right</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="mask_list" class="doc_header"><code>mask_list</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L234" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mask_list</code>(<strong><code>l1</code></strong>, <strong><code>p</code></strong>=<em><code>0.8</code></em>, <strong><code>mask</code></strong>=<em><code>1</code></em>, <strong><code>seed</code></strong>=<em><code>42</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="mask_last_elements_list" class="doc_header"><code>mask_last_elements_list</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L239" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mask_last_elements_list</code>(<strong><code>l1</code></strong>, <strong><code>val_context_size</code></strong>:<code>int</code>=<em><code>5</code></em>, <strong><code>seed</code></strong>=<em><code>42</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="masked_accuracy" class="doc_header"><code>masked_accuracy</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L243" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>masked_accuracy</code>(<strong><code>y_pred</code></strong>:<code>Tensor</code>, <strong><code>y_true</code></strong>:<code>Tensor</code>, <strong><code>mask</code></strong>:<code>Tensor</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="masked_ce" class="doc_header"><code>masked_ce</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/utils/common_utils.py#L250" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>masked_ce</code>(<strong><code>y_pred</code></strong>, <strong><code>y_true</code></strong>, <strong><code>mask</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <span class="n">assert_array_equal</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TestUtils</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">testColMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;test the column mapping function&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
             <span class="s1">&#39;sid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]}</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_name</span><span class="o">=</span><span class="s1">&#39;sid&#39;</span><span class="p">)</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sid_mapped</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                           <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">testSplit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;test the train/test/val split&quot;</span>
        <span class="n">SEED</span> <span class="o">=</span> <span class="mi">42</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                <span class="s1">&#39;sid&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">50</span><span class="p">))}</span>
        <span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">get_context</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">context_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">sid</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                           <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">testArrayPadding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;test array padding function&quot;</span>
        <span class="n">pad_output_1</span> <span class="o">=</span> <span class="n">pad_arr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]]),</span> <span class="n">expected_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">pad_output_2</span> <span class="o">=</span> <span class="n">pad_arr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]]),</span> <span class="n">expected_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">pad_output_1</span><span class="p">,</span>
                           <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]])</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">pad_output_2</span><span class="p">,</span>
                           <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span>
        
    <span class="k">def</span> <span class="nf">testListPadding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;test list padding function&quot;</span>
        <span class="n">pad_output_1</span> <span class="o">=</span> <span class="n">pad_list</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pad_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">pad_output_2</span> <span class="o">=</span> <span class="n">pad_list</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">pad_val</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">pad_output_1</span><span class="p">,</span>
                           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">pad_output_2</span><span class="p">,</span>
                           <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TestModelUtils</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">testMaskedAccuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;test the masked accuracy&quot;</span>
        <span class="n">output1</span> <span class="o">=</span> <span class="n">masked_accuracy</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]),</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">))</span>

        <span class="n">output2</span> <span class="o">=</span> <span class="n">masked_accuracy</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]),</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">output2</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">testMaskedCrossEntropy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.1049</span><span class="p">,</span> <span class="mf">1.5729</span><span class="p">,</span> <span class="mf">1.4864</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.8321</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3137</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3257</span><span class="p">]]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">output1</span> <span class="o">=</span> <span class="n">masked_ce</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">))</span>

        <span class="n">output2</span> <span class="o">=</span> <span class="n">masked_ce</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> 
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">))</span>
        
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">output1</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.4015</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">output2</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.1026</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">testMaskList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">mask_list</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span>
                           <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">mask_list</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span>
                           <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">testMaskListLastElement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
        <span class="n">output1</span> <span class="o">=</span> <span class="n">mask_last_elements_list</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">val_context_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">output2</span> <span class="o">=</span> <span class="n">mask_last_elements_list</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">val_context_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">output1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">assert_array_equal</span><span class="p">(</span><span class="n">output2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">exit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>testMaskList (__main__.TestModelUtils) ... ok
testMaskListLastElement (__main__.TestModelUtils) ... ok
testMaskedAccuracy (__main__.TestModelUtils)
test the masked accuracy ... ok
testMaskedCrossEntropy (__main__.TestModelUtils) ... ok
testArrayPadding (__main__.TestUtils)
test array padding function ... ok
testColMapping (__main__.TestUtils)
test the column mapping function ... ok
testListPadding (__main__.TestUtils)
test list padding function ... ok
testSplit (__main__.TestUtils)
test the train/test/val split ... ok

----------------------------------------------------------------------
Ran 8 tests in 0.032s

OK
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;unittest.main.TestProgram at 0x7fc8ba85ced0&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

