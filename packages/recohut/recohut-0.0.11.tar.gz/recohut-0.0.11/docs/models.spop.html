---

title: S-Pop


keywords: fastai
sidebar: home_sidebar

summary: "Session Popularity"
description: "Session Popularity"
nb_path: "nbs/models/models.spop.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/models/models.spop.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SessionPop" class="doc_header"><code>class</code> <code>SessionPop</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/models/spop.py#L10" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SessionPop</code>(<strong><code>top_n</code></strong>=<em><code>1000</code></em>, <strong><code>session_key</code></strong>=<em><code>'SessionId'</code></em>, <strong><code>item_key</code></strong>=<em><code>'ItemId'</code></em>)</p>
</blockquote>
<p>SessionPop(top_n=100, item_key='ItemId', support_by<em>key=None)
Session popularity predictor that gives higher scores to items with higher number of occurrences in the session.
Ties are broken up by adding the popularity score of the item.
The score is given by:
.. math::
    r</em>{s,i} = supp_{s,i} + \frac{supp_i}{(1+supp_i)}</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>top_n : int
    Only give back non-zero scores to the top N ranking items. Should be higher or equal than the cut-off of your evaluation. (Default value: 100)
item_key : string
    The header of the item IDs in the training data. (Default value: 'ItemId')</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">recohut.utils.common_utils</span> <span class="kn">import</span> <span class="n">download_url</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_root</span> <span class="o">=</span> <span class="s1">&#39;/content/data&#39;</span>
<span class="n">download_url</span><span class="p">(</span><span class="s1">&#39;https://github.com/RecoHut-Datasets/yoochoose/raw/v4/yoochoose_train.txt&#39;</span><span class="p">,</span> <span class="n">data_root</span><span class="p">)</span>
<span class="n">download_url</span><span class="p">(</span><span class="s1">&#39;https://github.com/RecoHut-Datasets/yoochoose/raw/v4/yoochoose_valid.txt&#39;</span><span class="p">,</span> <span class="n">data_root</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Downloading https://github.com/RecoHut-Datasets/yoochoose/raw/v4/yoochoose_train.txt
Downloading https://github.com/RecoHut-Datasets/yoochoose/raw/v4/yoochoose_valid.txt
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;/content/data/yoochoose_valid.txt&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--K&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;K items to be used in Recall@K and MRR@K&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--topn&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of top items to return non zero scores for them (most popular)&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--itemid&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;sid&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sessionid&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--valid_data&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;yoochoose_valid.txt&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--train_data&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;yoochoose_train.txt&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data_folder&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Get the arguments</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([])</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">valid_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_folder</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">valid_data</span><span class="p">)</span>
<span class="n">x_valid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
<span class="n">x_valid</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sessionid</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished Reading Data </span><span class="se">\n</span><span class="s1">Start Model Fitting...&#39;</span><span class="p">)</span>
<span class="c1"># Fitting AR Model</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SessionPop</span><span class="p">(</span><span class="n">top_n</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">topn</span><span class="p">,</span> <span class="n">session_key</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">sessionid</span><span class="p">,</span> <span class="n">item_key</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">itemid</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;End Model Fitting with total time =&#39;</span><span class="p">,</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Start Predictions...&#39;</span><span class="p">)</span>

<span class="c1"># Test Set Evaluation</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">hit</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">MRR</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">cur_length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">cur_session</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">last_items</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">index_item</span> <span class="o">=</span> <span class="n">x_valid</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">itemid</span><span class="p">)</span>
<span class="n">index_session</span> <span class="o">=</span> <span class="n">x_valid</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sessionid</span><span class="p">)</span>
<span class="n">train_items</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">items</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">x_valid</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">counter</span> <span class="o">%</span> <span class="mi">5000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished Prediction for &#39;</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="s1">&#39;items.&#39;</span><span class="p">)</span>
    <span class="n">session_id</span><span class="p">,</span> <span class="n">item_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_session</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">index_item</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">session_id</span> <span class="o">!=</span> <span class="n">cur_session</span><span class="p">:</span>
        <span class="n">cur_session</span> <span class="o">=</span> <span class="n">session_id</span>
        <span class="n">last_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cur_length</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">item_id</span> <span class="ow">in</span> <span class="n">train_items</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cur_length</span><span class="p">:</span> <span class="c1">#make prediction</span>
            <span class="n">cur_length</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">test_size</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Predict the most similar items to items</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_next</span><span class="p">(</span><span class="n">last_items</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
            <span class="c1"># Evaluation</span>
            <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">predicted_item</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
                <span class="n">rank</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">predicted_item</span> <span class="o">==</span> <span class="n">item_id</span><span class="p">:</span>
                    <span class="n">hit</span> <span class="o">+=</span> <span class="mf">1.0</span>
                    <span class="n">MRR</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">/</span><span class="n">rank</span>
                    <span class="k">break</span>
        
        <span class="n">last_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_id</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recall: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hit</span> <span class="o">/</span> <span class="n">test_size</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MRR: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MRR</span> <span class="o">/</span> <span class="n">test_size</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;End Model Predictions with total time =&#39;</span><span class="p">,</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Finished Reading Data 
Start Model Fitting...
End Model Fitting with total time = 0.10341858863830566 
 Start Predictions...
Finished Prediction for  5000 items.
Recall: 0.313485342019544

MRR: 0.11998186799961241
End Model Predictions with total time = 33.76607871055603
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p><strong>References:-</strong>- <a href="https://github.com/mmaher22/iCV-SBR/tree/master/Source%20Codes/S-POP_Python">https://github.com/mmaher22/iCV-SBR/tree/master/Source Codes/S-POP_Python</a></p>
</blockquote>

</div>
</div>
</div>
</div>
 

