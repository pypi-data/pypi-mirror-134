---

title: Trainer


keywords: fastai
sidebar: home_sidebar

summary: "Implementation of PyTorch model trainer."
description: "Implementation of PyTorch model trainer."
nb_path: "nbs/trainers/trainers.trainer.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/trainers/trainers.trainer.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="v1">v1<a class="anchor-link" href="#v1"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">recohut.datasets.movielens</span> <span class="kn">import</span> <span class="n">ML1mRatingDataset</span>

<span class="c1"># models</span>
<span class="kn">from</span> <span class="nn">recohut.models.afm</span> <span class="kn">import</span> <span class="n">AFM</span>
<span class="kn">from</span> <span class="nn">recohut.models.afn</span> <span class="kn">import</span> <span class="n">AFN</span>
<span class="kn">from</span> <span class="nn">recohut.models.autoint</span> <span class="kn">import</span> <span class="n">AutoInt</span>
<span class="kn">from</span> <span class="nn">recohut.models.dcn</span> <span class="kn">import</span> <span class="n">DCN</span>
<span class="kn">from</span> <span class="nn">recohut.models.deepfm</span> <span class="kn">import</span> <span class="n">DeepFM</span>
<span class="kn">from</span> <span class="nn">recohut.models.ffm</span> <span class="kn">import</span> <span class="n">FFM</span>
<span class="kn">from</span> <span class="nn">recohut.models.fm</span> <span class="kn">import</span> <span class="n">FM</span>
<span class="kn">from</span> <span class="nn">recohut.models.fnfm</span> <span class="kn">import</span> <span class="n">FNFM</span>
<span class="kn">from</span> <span class="nn">recohut.models.fnn</span> <span class="kn">import</span> <span class="n">FNN</span>
<span class="kn">from</span> <span class="nn">recohut.models.hofm</span> <span class="kn">import</span> <span class="n">HOFM</span>
<span class="kn">from</span> <span class="nn">recohut.models.lr</span> <span class="kn">import</span> <span class="n">LR</span>
<span class="kn">from</span> <span class="nn">recohut.models.ncf</span> <span class="kn">import</span> <span class="n">NCF</span>
<span class="kn">from</span> <span class="nn">recohut.models.nfm</span> <span class="kn">import</span> <span class="n">NFM</span>
<span class="kn">from</span> <span class="nn">recohut.models.ncf</span> <span class="kn">import</span> <span class="n">NCF</span>
<span class="kn">from</span> <span class="nn">recohut.models.pnn</span> <span class="kn">import</span> <span class="n">PNN</span>
<span class="kn">from</span> <span class="nn">recohut.models.wide_and_deep</span> <span class="kn">import</span> <span class="n">WideAndDeep</span>
<span class="kn">from</span> <span class="nn">recohut.models.xdeepfm</span> <span class="kn">import</span> <span class="n">xDeepFM</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">ML1mRatingDataset</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;/content/ML1m&#39;</span><span class="p">,</span> <span class="n">min_uc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_sc</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Downloading http://files.grouplens.org/datasets/movielens/ml-1m.zip
Extracting /content/ML1m/raw/ml-1m.zip
Processing...
Done!
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;ml_1m&#39;</span><span class="p">,</span>
                 <span class="n">model</span><span class="o">=</span><span class="s1">&#39;wide_and_deep&#39;</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="c1"># dataset</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;ml_1m&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset_root</span> <span class="o">=</span> <span class="s1">&#39;/content/ML1m&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_uc</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_sc</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="c1"># model training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span> <span class="c1"># &#39;cuda:0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="s1">&#39;/content/chkpt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="c1"># model architecture</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;wide_and_deep&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;fm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ffm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;hofm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;fnn&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ipnn&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;opnn&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;outer&#39;</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;dcn&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;nfm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">64</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ncf&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;fnfm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;deep_fm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;xdeep_fm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cross_layer_sizes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">split_half</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;afm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attn_size</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;autoint&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atten_embed_dim</span> <span class="o">=</span> <span class="mi">64</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;afn&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LNN_dim</span> <span class="o">=</span> <span class="mi">1500</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;ml_1m&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ML1mRatingDataset</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_root</span><span class="p">,</span>
                                     <span class="n">min_uc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_uc</span><span class="p">,</span>
                                     <span class="n">min_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sc</span>
                                     <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_dims</span><span class="p">,</span> <span class="n">user_field_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_field_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;wide_and_deep&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WideAndDeep</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                               <span class="n">embed_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                               <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                               <span class="n">dropout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span>
                               <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;fm&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FM</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                      <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;lr&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LR</span><span class="p">(</span><span class="n">field_dims</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ffm&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FFM</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;hofm&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HOFM</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                        <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;fnn&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FNN</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">dropout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ipnn&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PNN</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                       <span class="n">dropout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;opnn&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PNN</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                       <span class="n">dropout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;dcn&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DCN</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">num_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                       <span class="n">dropout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;nfm&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NFM</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ncf&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NCF</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">dropout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                       <span class="n">user_field_idx</span><span class="o">=</span><span class="n">user_field_idx</span><span class="p">,</span>
                       <span class="n">item_field_idx</span><span class="o">=</span><span class="n">item_field_idx</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;fnfm&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FNFM</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;deep_fm&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DeepFM</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                          <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                          <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                          <span class="n">dropout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;xdeep_fm&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xDeepFM</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">dropout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                       <span class="n">cross_layer_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_layer_sizes</span><span class="p">,</span>
                       <span class="n">split_half</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_half</span><span class="p">,</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;afm&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AFM</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                       <span class="n">attn_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_size</span><span class="p">,</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;autoint&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AutoInt</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                       <span class="n">atten_embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten_embed_dim</span><span class="p">,</span>
                       <span class="n">num_heads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">,</span>
                       <span class="n">num_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span>
                      <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;afn&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AFN</span><span class="p">(</span><span class="n">field_dims</span><span class="p">,</span>
                       <span class="n">embed_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span>
                       <span class="n">mlp_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_dims</span><span class="p">,</span>
                       <span class="n">dropouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropouts</span><span class="p">,</span>
                       <span class="n">LNN_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LNN_dim</span><span class="p">,</span>
                      <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">EarlyStopper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_trials</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span> <span class="o">=</span> <span class="n">num_trials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_accuracy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span>

    <span class="k">def</span> <span class="nf">is_continuable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">accuracy</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_accuracy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_accuracy</span> <span class="o">=</span> <span class="n">accuracy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trial_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_counter</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trial_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># dataset</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
        <span class="c1"># model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">field_dims</span><span class="p">,</span>
                               <span class="n">user_field_idx</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">user_field_idx</span><span class="p">,</span>
                               <span class="n">item_field_idx</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">item_field_idx</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="c1"># data split</span>
        <span class="n">train_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">valid_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">test_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_length</span> <span class="o">-</span> <span class="n">valid_length</span>
        <span class="c1"># data loader</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span> <span class="p">(</span><span class="n">train_length</span><span class="p">,</span> <span class="n">valid_length</span><span class="p">,</span> <span class="n">test_length</span><span class="p">))</span>
        <span class="n">train_data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">)</span>
        <span class="n">valid_data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">valid_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">)</span>
        <span class="n">test_data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">)</span>
        <span class="c1"># handlers</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BCELoss</span><span class="p">()</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">early_stopper</span> <span class="o">=</span> <span class="n">EarlyStopper</span><span class="p">(</span><span class="n">num_trials</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">save_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">.pt&#39;</span><span class="p">)</span>
        <span class="c1"># # scheduler</span>
        <span class="c1"># # ref - https://github.com/sparsh-ai/stanza/blob/7961a0a00dc06b9b28b71954b38181d6a87aa803/trainer/bert.py#L36</span>
        <span class="c1"># import torch.optim as optim</span>
        <span class="c1"># if args.enable_lr_schedule:</span>
        <span class="c1">#     if args.enable_lr_warmup:</span>
        <span class="c1">#         self.lr_scheduler = self.get_linear_schedule_with_warmup(</span>
        <span class="c1">#             optimizer, args.warmup_steps, len(train_data_loader) * self.n_epochs)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         self.lr_scheduler = optim.lr_scheduler.StepLR(</span>
        <span class="c1">#             optimizer, step_size=args.decay_step, gamma=args.gamma)</span>
        <span class="c1"># training</span>
        <span class="k">for</span> <span class="n">epoch_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">n_epochs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">train_data_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">valid_data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch:&#39;</span><span class="p">,</span> <span class="n">epoch_i</span><span class="p">,</span> <span class="s1">&#39;validation: auc:&#39;</span><span class="p">,</span> <span class="n">auc</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">early_stopper</span><span class="o">.</span><span class="n">is_continuable</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">auc</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;validation: best auc: </span><span class="si">{</span><span class="n">early_stopper</span><span class="o">.</span><span class="n">best_accuracy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">auc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test auc: </span><span class="si">{</span><span class="n">auc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tk0</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tk0</span><span class="p">):</span>
            <span class="n">fields</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
            <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># self.clip_gradients(5)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="c1"># if self.args.enable_lr_schedule:</span>
            <span class="c1">#     self.lr_scheduler.step()</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">log_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tk0</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">total_loss</span> <span class="o">/</span> <span class="n">log_interval</span><span class="p">)</span>
                <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">predicts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">fields</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
                <span class="n">fields</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
                <span class="n">targets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">predicts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">predicts</span><span class="p">)</span>

    <span class="c1"># def clip_gradients(self, limit=5):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Reference:</span>
    <span class="c1">#         1. https://github.com/sparsh-ai/stanza/blob/7961a0a00dc06b9b28b71954b38181d6a87aa803/trainer/bert.py#L175</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     for p in self.model.parameters():</span>
    <span class="c1">#         nn.utils.clip_grad_norm_(p, 5)</span>

    <span class="c1"># def _create_optimizer(self):</span>
    <span class="c1">#     args = self.args</span>
    <span class="c1">#     param_optimizer = list(self.model.named_parameters())</span>
    <span class="c1">#     no_decay = [&#39;bias&#39;, &#39;layer_norm&#39;]</span>
    <span class="c1">#     optimizer_grouped_parameters = [</span>
    <span class="c1">#         {</span>
    <span class="c1">#             &#39;params&#39;: [p for n, p in param_optimizer if not any(nd in n for nd in no_decay)],</span>
    <span class="c1">#             &#39;weight_decay&#39;: args.weight_decay,</span>
    <span class="c1">#         },</span>
    <span class="c1">#         {&#39;params&#39;: [p for n, p in param_optimizer if any(nd in n for nd in no_decay)], &#39;weight_decay&#39;: 0.0},</span>
    <span class="c1">#     ]</span>
    <span class="c1">#     if args.optimizer.lower() == &#39;adamw&#39;:</span>
    <span class="c1">#         return optim.AdamW(optimizer_grouped_parameters, lr=args.lr, eps=args.adam_epsilon)</span>
    <span class="c1">#     elif args.optimizer.lower() == &#39;adam&#39;:</span>
    <span class="c1">#         return optim.Adam(optimizer_grouped_parameters, lr=args.lr, weight_decay=args.weight_decay)</span>
    <span class="c1">#     elif args.optimizer.lower() == &#39;sgd&#39;:</span>
    <span class="c1">#         return optim.SGD(optimizer_grouped_parameters, lr=args.lr, weight_decay=args.weight_decay, momentum=args.momentum)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         raise ValueError</span>

    <span class="c1"># def get_linear_schedule_with_warmup(self, optimizer, num_warmup_steps, num_training_steps, last_epoch=-1):</span>
    <span class="c1">#     # based on hugging face get_linear_schedule_with_warmup</span>
    <span class="c1">#     def lr_lambda(current_step: int):</span>
    <span class="c1">#         if current_step &lt; num_warmup_steps:</span>
    <span class="c1">#             return float(current_step) / float(max(1, num_warmup_steps))</span>
    <span class="c1">#         return max(</span>
    <span class="c1">#             0.0, float(num_training_steps - current_step) / float(max(1, num_training_steps - num_warmup_steps))</span>
    <span class="c1">#         )</span>

    <span class="c1">#     return LambdaLR(optimizer, lr_lambda, last_epoch)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s1">&#39;wide_and_deep&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fm&#39;</span><span class="p">,</span>
          <span class="s1">&#39;lr&#39;</span><span class="p">,</span>
          <span class="s1">&#39;ffm&#39;</span><span class="p">,</span>
          <span class="s1">&#39;hofm&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fnn&#39;</span><span class="p">,</span>
          <span class="s1">&#39;ipnn&#39;</span><span class="p">,</span>
          <span class="s1">&#39;opnn&#39;</span><span class="p">,</span>
          <span class="s1">&#39;dcn&#39;</span><span class="p">,</span>
          <span class="s1">&#39;nfm&#39;</span><span class="p">,</span>
          <span class="s1">&#39;ncf&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fnfm&#39;</span><span class="p">,</span>
          <span class="s1">&#39;deep_fm&#39;</span><span class="p">,</span>
          <span class="s1">&#39;xdeep_fm&#39;</span><span class="p">,</span>
          <span class="s1">&#39;afm&#39;</span><span class="p">,</span>
        <span class="c1">#   &#39;autoint&#39;,</span>
        <span class="c1">#   &#39;afn&#39;</span>
          <span class="p">]</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Processing...
Done!
100%|██████████| 3126/3126 [00:23&lt;00:00, 135.91it/s, loss=0.57]
100%|██████████| 391/391 [00:01&lt;00:00, 252.62it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7781601005135064
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:22&lt;00:00, 137.03it/s, loss=0.557]
100%|██████████| 391/391 [00:01&lt;00:00, 259.00it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7842454181872189
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 261.87it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.783773499847308
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:15&lt;00:00, 200.85it/s, loss=0.587]
100%|██████████| 391/391 [00:01&lt;00:00, 277.38it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7511323978391329
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:15&lt;00:00, 203.24it/s, loss=0.542]
100%|██████████| 391/391 [00:01&lt;00:00, 286.19it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7852232398637453
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 286.62it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7851983970544512
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:12&lt;00:00, 243.01it/s, loss=0.713]
100%|██████████| 391/391 [00:01&lt;00:00, 290.07it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.606845663039941
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:12&lt;00:00, 243.68it/s, loss=0.625]
100%|██████████| 391/391 [00:01&lt;00:00, 290.60it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.6962495583229628
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 280.21it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.6917994954031111
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:16&lt;00:00, 189.89it/s, loss=0.639]
100%|██████████| 391/391 [00:01&lt;00:00, 275.44it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.6956660360854087
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:16&lt;00:00, 190.43it/s, loss=0.559]
100%|██████████| 391/391 [00:01&lt;00:00, 279.32it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.769259926201433
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 275.84it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7694256825177728
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:23&lt;00:00, 135.66it/s, loss=0.585]
100%|██████████| 391/391 [00:01&lt;00:00, 229.47it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7508361070441243
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:23&lt;00:00, 135.52it/s, loss=0.538]
100%|██████████| 391/391 [00:01&lt;00:00, 229.00it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7867336507526798
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 226.59it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7849653473859624
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:21&lt;00:00, 146.97it/s, loss=0.554]
100%|██████████| 391/391 [00:01&lt;00:00, 272.83it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7899586086314532
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:21&lt;00:00, 148.00it/s, loss=0.544]
100%|██████████| 391/391 [00:01&lt;00:00, 268.07it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7938707366151592
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 267.69it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7935777015287597
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:20&lt;00:00, 151.01it/s, loss=0.55]
100%|██████████| 391/391 [00:01&lt;00:00, 253.01it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7901787607777198
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:20&lt;00:00, 151.50it/s, loss=0.536]
100%|██████████| 391/391 [00:01&lt;00:00, 258.53it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7958062417181883
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 265.78it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7959379435427811
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:21&lt;00:00, 144.98it/s, loss=0.548]
100%|██████████| 391/391 [00:01&lt;00:00, 256.43it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7943316704845618
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:21&lt;00:00, 145.26it/s, loss=0.53]
100%|██████████| 391/391 [00:01&lt;00:00, 252.76it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.8027591784990165
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 259.79it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.8016146552653354
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:26&lt;00:00, 116.37it/s, loss=0.537]
100%|██████████| 391/391 [00:01&lt;00:00, 240.12it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7898151214837668
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:26&lt;00:00, 116.92it/s, loss=0.527]
100%|██████████| 391/391 [00:01&lt;00:00, 239.57it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7955138244674892
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 240.84it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7964998271099959
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:22&lt;00:00, 138.66it/s, loss=0.586]
100%|██████████| 391/391 [00:01&lt;00:00, 252.66it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7631548463451637
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:22&lt;00:00, 137.08it/s, loss=0.551]
100%|██████████| 391/391 [00:01&lt;00:00, 251.84it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7752154803420491
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 252.42it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7727792981788815
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:23&lt;00:00, 132.24it/s, loss=0.554]
100%|██████████| 391/391 [00:01&lt;00:00, 248.61it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7876433331502086
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:23&lt;00:00, 132.00it/s, loss=0.543]
100%|██████████| 391/391 [00:01&lt;00:00, 249.84it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7923030405914255
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 257.83it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7930787548185895
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:23&lt;00:00, 133.99it/s, loss=0.61]
100%|██████████| 391/391 [00:01&lt;00:00, 250.20it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7376150945998978
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:23&lt;00:00, 135.18it/s, loss=0.583]
100%|██████████| 391/391 [00:01&lt;00:00, 246.25it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7583206065924306
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 245.77it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7594084947700983
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:24&lt;00:00, 127.45it/s, loss=0.569]
100%|██████████| 391/391 [00:01&lt;00:00, 244.49it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7806048647711028
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:24&lt;00:00, 128.70it/s, loss=0.554]
100%|██████████| 391/391 [00:01&lt;00:00, 246.00it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7857091265544482
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 245.62it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7857843263334994
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:30&lt;00:00, 103.68it/s, loss=0.558]
100%|██████████| 391/391 [00:01&lt;00:00, 219.06it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7814674364890849
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:29&lt;00:00, 104.41it/s, loss=0.539]
100%|██████████| 391/391 [00:01&lt;00:00, 214.94it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7899837530572655
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 216.12it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7863345464272122
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [00:23&lt;00:00, 133.32it/s, loss=0.606]
100%|██████████| 391/391 [00:01&lt;00:00, 244.59it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7590887701790624
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:23&lt;00:00, 134.06it/s, loss=0.576]
100%|██████████| 391/391 [00:01&lt;00:00, 247.06it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7820711568875622
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:01&lt;00:00, 247.66it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7835448236219698
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s1">&#39;autoint&#39;</span><span class="p">,</span>
          <span class="s1">&#39;afn&#39;</span>
          <span class="p">]</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Processing...
Done!
100%|██████████| 3126/3126 [00:43&lt;00:00, 72.44it/s, loss=0.551]
100%|██████████| 391/391 [00:02&lt;00:00, 171.82it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7838440329134869
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [00:42&lt;00:00, 73.24it/s, loss=0.532]
100%|██████████| 391/391 [00:02&lt;00:00, 172.49it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7924653055551055
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:02&lt;00:00, 169.07it/s]
Processing...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7935854845577758
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Done!
100%|██████████| 3126/3126 [01:24&lt;00:00, 37.12it/s, loss=0.564]
100%|██████████| 391/391 [00:03&lt;00:00, 107.76it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 0 validation: auc: 0.7796980126749351
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 3126/3126 [01:23&lt;00:00, 37.50it/s, loss=0.547]
100%|██████████| 391/391 [00:03&lt;00:00, 108.16it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>epoch: 1 validation: auc: 0.7879478169612124
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 391/391 [00:03&lt;00:00, 108.09it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test auc: 0.7893059350190452
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>tree --du -h -C /content/chkpt
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre><span class="ansi-blue-intense-fg ansi-bold">/content/chkpt</span>
├── [669K]  AFM.pt
├── [ 39M]  AFN.pt
├── [1.5M]  AutoInt.pt
├── [640K]  DCN.pt
├── [676K]  DeepFM.pt
├── [355K]  FFM.pt
├── [666K]  FM.pt
├── [363K]  FNFM.pt
├── [636K]  FNN.pt
├── [1.3M]  HOFM.pt
├── [ 41K]  LR.pt
├── [636K]  NCF.pt
├── [2.5M]  NFM.pt
├── [1.2M]  PNN.pt
├── [676K]  WideAndDeep.pt
└── [682K]  xDeepFM.pt

  51M used in 0 directories, 16 files
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="v2">v2<a class="anchor-link" href="#v2"> </a></h2><p><strong>References:-</strong></p>
<ol>
<li><a href="https://nbviewer.org/github/CS-512-Recsys/Recsys/blob/main/nbs/basic_implementation.ipynb">https://nbviewer.org/github/CS-512-Recsys/Recsys/blob/main/nbs/basic_implementation.ipynb</a></li>
</ol>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install -q wandb
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">dump</span><span class="p">,</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span> <span class="k">as</span> <span class="n">dl</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RecsysDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">usr_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mov_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usr_dict</span> <span class="o">=</span> <span class="n">usr_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mov_dict</span> <span class="o">=</span> <span class="n">mov_dict</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usr_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mov_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">usr_dict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;user_id&#39;</span><span class="p">])],</span><span class="bp">self</span><span class="o">.</span><span class="n">mov_dict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;movie_id&#39;</span><span class="p">])]],</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;movie_id&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
            
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>


<span class="n">sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;movie_id&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;rating&#39;</span><span class="p">:[</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">1.3</span><span class="p">,</span><span class="mf">3.5</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">4.5</span><span class="p">]})</span>
<span class="n">trn_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="mi">4</span><span class="p">,)</span>
<span class="n">valid_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trn_ids</span><span class="p">]</span>

<span class="n">sample_trn</span><span class="p">,</span><span class="n">sample_vld</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">trn_ids</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()),</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_ids</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>

<span class="n">sample_vld</span> <span class="o">=</span> <span class="n">RecsysDataset</span><span class="p">(</span><span class="n">sample_vld</span><span class="p">)</span>
<span class="n">sample_trn</span> <span class="o">=</span> <span class="n">RecsysDataset</span><span class="p">(</span><span class="n">sample_trn</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">dl</span><span class="p">(</span><span class="n">sample_trn</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">valid_loader</span> <span class="o">=</span> <span class="n">dl</span><span class="p">(</span><span class="n">sample_vld</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">NCF</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_sz</span><span class="p">,</span><span class="n">item_sz</span><span class="p">,</span><span class="n">embd_sz</span><span class="p">,</span><span class="n">dropout_fac</span><span class="p">,</span><span class="n">min_r</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">max_r</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">with_variable_alpha</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_fac</span> <span class="o">=</span> <span class="n">dropout_fac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_embd_mtrx</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">user_sz</span><span class="p">,</span><span class="n">embd_sz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_embd_mtrx</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">item_sz</span><span class="p">,</span><span class="n">embd_sz</span><span class="p">)</span>
        <span class="c1">#bias = torch.zeros(size=(user_sz, 1), requires_grad=True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span>  <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embd_sz</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fst_lyr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embd_sz</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">embd_sz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snd_lyr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embd_sz</span><span class="p">,</span><span class="n">embd_sz</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thrd_lyr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embd_sz</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">embd_sz</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_lyr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embd_sz</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_r</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_r</span> <span class="o">=</span> <span class="n">min_r</span><span class="p">,</span><span class="n">max_r</span>
        <span class="k">if</span> <span class="n">with_variable_alpha</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="n">user_emd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_embd_mtrx</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">item_emd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_embd_mtrx</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#hadamard-product</span>
        <span class="n">gmf</span> <span class="o">=</span> <span class="n">user_emd</span><span class="o">*</span><span class="n">item_emd</span>
        <span class="n">gmf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">gmf</span><span class="p">)</span>
        
        
        <span class="n">mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">user_emd</span><span class="p">,</span><span class="n">item_emd</span><span class="p">],</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_lyr</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thrd_lyr</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snd_lyr</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fst_lyr</span><span class="p">(</span><span class="n">mlp</span><span class="p">)),</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_fac</span><span class="p">))))))</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">fac</span><span class="o">*</span><span class="n">gmf</span><span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fac</span><span class="p">)</span><span class="o">*</span><span class="n">mlp</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_r</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">NCF</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
    <span class="c1">#user,item = u</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;user:</span><span class="si">{</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,item:</span><span class="si">{</span><span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> and rating:</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1">#print(u)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output of the network=&gt; out:</span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s1">,shape:</span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>user:tensor([2, 1]),item:tensor([2, 0]) and rating:tensor([4.0000, 4.5000], dtype=torch.float64)
output of the network=&gt; out:tensor([[0.4322],
        [0.5724]], grad_fn=&lt;ClampBackward1&gt;),shape:torch.Size([2, 1])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Trainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span><span class="n">loss_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">artifacts_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exp_tracker</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Set params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loss_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_loc</span> <span class="o">=</span> <span class="n">artifacts_loc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_tracker</span> <span class="o">=</span> <span class="n">exp_tracker</span>

    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train step.&quot;&quot;&quot;</span>
        <span class="c1"># Set model to train mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Iterate over train batches</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="c1">#batch = [item.to(self.device) for item in batch]  # Set device</span>
            <span class="n">inputs</span><span class="p">,</span><span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="c1">#inputs, targets = batch[:-1], batch[-1]</span>
            <span class="c1">#import pdb;pdb.set_trace()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>  <span class="c1"># Reset gradients</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>  <span class="c1"># Forward pass</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">targets</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>  <span class="c1"># Define loss</span>
            <span class="n">J</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>  <span class="c1"># Backward pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># Update weights</span>

            <span class="c1"># Cumulative Metrics</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">-</span> <span class="n">loss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validation or test step.&quot;&quot;&quot;</span>
        <span class="c1"># Set model to eval mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">y_trues</span><span class="p">,</span> <span class="n">y_probs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="c1"># Iterate over val batches</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
                <span class="n">inputs</span><span class="p">,</span><span class="n">y_true</span> <span class="o">=</span> <span class="n">batch</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>
                <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

                <span class="c1"># Step</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># Forward pass</span>
                <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                <span class="c1"># Cumulative Metrics</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">J</span> <span class="o">-</span> <span class="n">loss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Store outputs</span>
                <span class="n">y_prob</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">y_probs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y_prob</span><span class="p">)</span>
                <span class="n">y_trues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y_true</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">y_trues</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prediction step.&quot;&quot;&quot;</span>
        <span class="c1"># Set model to eval mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">y_probs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Iterate over val batches</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>

                <span class="c1"># Forward pass w/ inputs</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

                <span class="c1"># Store outputs</span>
                <span class="n">y_prob</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">y_probs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y_prob</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">patience</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">val_dataloader</span><span class="p">,</span> 
              <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
        <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">training_stats</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">)):</span>
            <span class="c1"># Steps</span>
            <span class="n">train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">dataloader</span><span class="o">=</span><span class="n">train_dataloader</span><span class="p">)</span>
            <span class="n">val_loss</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_step</span><span class="p">(</span><span class="n">dataloader</span><span class="o">=</span><span class="n">val_dataloader</span><span class="p">)</span>
            <span class="c1">#store stats</span>
            <span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
            <span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
            <span class="c1">#log-stats</span>
            <span class="c1"># wandb.init(project=f&quot;{args.trail_id}_{args.dataset}_{args.data_type}&quot;,config=config_dict)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_tracker</span> <span class="o">==</span> <span class="s1">&#39;wandb&#39;</span><span class="p">:</span>
                <span class="n">log_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;epoch&#39;</span><span class="p">:</span><span class="n">epoch</span><span class="p">,</span><span class="s1">&#39;train_loss&#39;</span><span class="p">:</span><span class="n">train_loss</span><span class="p">,</span><span class="s1">&#39;val_loss&#39;</span><span class="p">:</span><span class="n">val_loss</span><span class="p">}</span>
                <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_metrics</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>

            <span class="c1"># Early stopping</span>
            <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
                <span class="n">best_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
                <span class="n">_patience</span> <span class="o">=</span> <span class="n">patience</span>  <span class="c1"># reset _patience</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_patience</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_patience</span><span class="p">:</span>  <span class="c1"># 0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping early!&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># Tracking</span>
            <span class="c1">#mlflow.log_metrics({&quot;train_loss&quot;: train_loss, &quot;val_loss&quot;: val_loss}, step=epoch)</span>

            <span class="c1"># Logging</span>
            <span class="k">if</span> <span class="n">epoch</span><span class="o">%</span><span class="k">5</span> == 0:
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> | &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;train_loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;val_loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;lr: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;_patience: </span><span class="si">{</span><span class="n">_patience</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_loc</span><span class="p">:</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_stats</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_loc</span><span class="o">/</span><span class="s1">&#39;training_stats.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">best_val_loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span><span class="n">loss_fn</span><span class="p">,</span><span class="n">optimizer</span><span class="p">,</span><span class="n">scheduler</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">train_loader</span><span class="p">,</span><span class="n">valid_loader</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre> 11%|█         | 11/100 [00:00&lt;00:01, 50.86it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch: 1 | train_loss: 8.55765, val_loss: 8.12049, lr: 1.00E-03, _patience: 10
Epoch: 6 | train_loss: 8.41908, val_loss: 8.07732, lr: 1.00E-03, _patience: 9
Epoch: 11 | train_loss: 8.28326, val_loss: 8.00117, lr: 1.00E-03, _patience: 8
Epoch: 16 | train_loss: 8.15473, val_loss: 7.88881, lr: 1.00E-03, _patience: 10
Epoch: 21 | train_loss: 8.01803, val_loss: 7.85543, lr: 1.00E-03, _patience: 8
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre> 45%|████▌     | 45/100 [00:00&lt;00:00, 93.60it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch: 26 | train_loss: 7.88548, val_loss: 7.76981, lr: 1.00E-03, _patience: 10
Epoch: 31 | train_loss: 7.75244, val_loss: 7.69328, lr: 1.00E-03, _patience: 9
Epoch: 36 | train_loss: 7.61687, val_loss: 7.61532, lr: 1.00E-03, _patience: 9
Epoch: 41 | train_loss: 7.48551, val_loss: 7.53750, lr: 1.00E-03, _patience: 9
Epoch: 46 | train_loss: 7.35090, val_loss: 7.42478, lr: 1.00E-03, _patience: 10
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre> 65%|██████▌   | 65/100 [00:00&lt;00:00, 96.05it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch: 51 | train_loss: 7.20997, val_loss: 7.34263, lr: 1.00E-03, _patience: 10
Epoch: 56 | train_loss: 7.07457, val_loss: 7.30977, lr: 1.00E-03, _patience: 9
Epoch: 61 | train_loss: 6.93769, val_loss: 7.23912, lr: 1.00E-03, _patience: 9
Epoch: 66 | train_loss: 6.80419, val_loss: 7.16288, lr: 1.00E-03, _patience: 9
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre> 85%|████████▌ | 85/100 [00:00&lt;00:00, 95.13it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch: 71 | train_loss: 6.66622, val_loss: 7.08776, lr: 1.00E-03, _patience: 8
Epoch: 76 | train_loss: 6.52944, val_loss: 6.96159, lr: 1.00E-03, _patience: 10
Epoch: 81 | train_loss: 6.38914, val_loss: 6.89294, lr: 1.00E-03, _patience: 10
Epoch: 86 | train_loss: 6.24970, val_loss: 6.86126, lr: 1.00E-03, _patience: 9
Epoch: 91 | train_loss: 6.10893, val_loss: 6.74132, lr: 1.00E-03, _patience: 10
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>100%|██████████| 100/100 [00:01&lt;00:00, 87.60it/s]</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch: 96 | train_loss: 5.96172, val_loss: 6.66766, lr: 1.00E-03, _patience: 10
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(NCF(
   (user_embd_mtrx): Embedding(3, 4)
   (item_embd_mtrx): Embedding(3, 4)
   (h): Linear(in_features=4, out_features=1, bias=True)
   (fst_lyr): Linear(in_features=8, out_features=4, bias=True)
   (snd_lyr): Linear(in_features=4, out_features=2, bias=True)
   (thrd_lyr): Linear(in_features=2, out_features=1, bias=True)
   (out_lyr): Linear(in_features=1, out_features=1, bias=True)
 ), 6.608727216720581)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

