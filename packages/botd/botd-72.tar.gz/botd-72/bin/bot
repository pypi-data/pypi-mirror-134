#!/usr/bin/env python3
# This file is placed in the Public Domain.


import os
import readline
import termios
import sys
import time


sys.path.insert(0, os.getcwd())


from bot.spc import Bus, Client, Event, Handler, Cfg, boot, kcmd, launch, scan


from bot.irc import IRC
from bot.irc import Cfg as ICfg
from bot.rss import Fetcher


import bot.all


Cfg.wd = os.path.expanduser("~/.bot")


class Console(Client, Handler):


    def __init__(self):
        Client.__init__(self)
        Handler.__init__(self)
        Bus.add(self)


    def handle(self, e):
        Handler.handle(self, e)
        e.wait()

    def poll(self):
        e = Event()
        e.orig = repr(self)
        e.txt = input("> ")
        return e

    def raw(self, txt):
        print(txt)


def daemon():
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    os.umask(0)
    si = open("/dev/null", 'r')
    so = open("/dev/null", 'a+')
    se = open("/dev/null", 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())


def watcher(clt, quit=False):
    done = []
    while 1:
        time.sleep(1.0)
        for ex in clt.errors:
            if "reason" in dir(ex) and ex not in done:
                print("\n")
                traceback.print_exception(type(ex), ex, ex.__traceback__)
                if quit:
                    break
            done.append(ex)
        if quit:
            break
    for ex in done:
        clt.errors.remove(ex)


def wrap(func):
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)

 
def main():
    boot(" ".join(sys.argv[1:]))
    scan()
    c = Console()
    if Cfg.txt:
        return kcmd(c, Cfg.otxt)
    if Cfg.daemon or "c" in Cfg.opts:
        if Cfg.daemon:
            daemon()
        print("BOT start at %s channel=%s daemon=%s sasl=%s" % (time.ctime(time.time()).replace("  ", " "), ICfg.channel, Cfg.daemon, ICfg.sasl))
        print("using %s!%s@%s:%s" % (ICfg.nick, ICfg.username, ICfg.server, ICfg.port))
        i = IRC()
        i.start()
        launch(watcher, i)
        f = Fetcher()
        f.start()
        c.start()
        while 1:
            time.sleep(1.0)

wrap(main)
