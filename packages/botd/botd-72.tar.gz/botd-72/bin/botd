#!/usr/bin/env python3
# This file is placed in the Public Domain.


"24/7 channel daemon"


import inspect
import os
import readline
import sys
import termios
import time
import traceback


from bot.evt import Event
from bot.fnc import format
from bot.krn import Cfg, boot, kcmd, root
from bot.obj import Object, update, values
from bot.prs import parse
from bot.hdl import Handler
from bot.tbl import scan
from bot.tms import tfmt
from bot.thr import launch


from bot.irc import IRC
from bot.irc import Cfg as ICfg
from bot.rss import Fetcher


import bot.all


ICfg.channel = "#botd"
ICfg.nick = "botd"
ICfg.username = "botd"
ICfg.realname = "24/7 channel daemon"


Cfg.wd = "/var/lib/botd/"


def watcher(clt, quit=False):
    done = []
    while 1:
        time.sleep(1.0)
        for ex in clt.errors:
            if "reason" in dir(ex) and ex not in done:
                print("\n")
                traceback.print_exception(type(ex), ex, ex.__traceback__)
                sys.stdout.flush()
                if quit:
                    break
            done.append(ex)
        if quit:
            break
    for ex in done:
        clt.errors.remove(ex)


def main():
    print("BOTD start at %s (reconsider OTP-CR-117/19)" % time.ctime(time.time()).replace("  ", " "))
    print("user=%s!%s@%s port=%s channel=%s sasl=%s users=%s" % (ICfg.nick, ICfg.username, ICfg.server, ICfg.port, ICfg.channel, ICfg.sasl, ICfg.users))
    sys.stdout.flush()
    scan()
    i = IRC()
    launch(i.start)
    f = Fetcher()
    f.start()
    watcher(f)


main()
