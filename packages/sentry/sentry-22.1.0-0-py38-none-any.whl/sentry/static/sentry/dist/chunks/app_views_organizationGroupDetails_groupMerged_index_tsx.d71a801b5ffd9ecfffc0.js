"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["app_views_organizationGroupDetails_groupMerged_index_tsx"],{"./app/actions/groupingActions.tsx":(e,t,s)=>{s.d(t,{Z:()=>i});var r=s("../node_modules/reflux/src/index.js");const i=s.n(r)().createActions(["fetch","showAllSimilarItems","toggleUnmerge","toggleMerge","unmerge","merge","toggleCollapseFingerprint","toggleCollapseFingerprints"])},"./app/stores/groupingStore.tsx":(e,t,s)=>{s.d(t,{Z:()=>h}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js");var r=s("../node_modules/lodash/pick.js"),i=s.n(r),n=s("../node_modules/reflux/src/index.js"),o=s.n(n),a=s("./app/actionCreators/group.tsx"),l=s("./app/actionCreators/indicator.tsx"),g=s("./app/actions/groupingActions.tsx"),d=s("./app/api.tsx");const p={listenables:[g.Z],api:new d.KU,init(){const e=this.getInitialState();Object.entries(e).forEach((([e,t])=>{this[e]=t}))},getInitialState:()=>({mergedItems:[],unmergeList:new Map,unmergeState:new Map,unmergeDisabled:!0,unmergeLastCollapsed:!1,enableFingerprintCompare:!1,similarItems:[],filteredSimilarItems:[],similarLinks:"",mergeState:new Map,mergeList:[],mergedLinks:"",mergeDisabled:!1,loading:!0,error:!1}),setStateForId:(e,t,s)=>(Array.isArray(t)?t:[t]).map((t=>{const r={...e.has(t)&&e.get(t)||{},...s};return e.set(t,r),r})),isAllUnmergedSelected(){const e=Array.from(this.unmergeState.values()).filter((({busy:e})=>e))||[];return this.unmergeList.size===this.mergedItems.filter((({latestEvent:e})=>!!e)).length-e.length},onFetch(e){const t=e||this.toFetchArray;this.init(),this.triggerFetchState();const s=t.map((({endpoint:e,queryParams:t,dataKey:s})=>new Promise(((r,i)=>{this.api.request(e,{method:"GET",data:t,success:(e,t,i)=>{r({dataKey:s,data:e,links:i?i.getResponseHeader("Link"):null})},error:e=>{var t;const s=(null===(t=e.responseJSON)||void 0===t?void 0:t.detail)||!0;i(s)}})})))),r={merged:e=>{const t={},s=[];return e.forEach((e=>{if(!t[e.id]){const r={eventCount:0,children:[],...e};this.setStateForId(this.unmergeState,e.id,{busy:"locked"===e.state}),t[e.id]=r,s.push(r)}const r=t[e.id],{childId:i,childLabel:n,eventCount:o,lastSeen:a,latestEvent:l}=e;o&&(r.eventCount+=o),i&&r.children.push({childId:i,childLabel:n,lastSeen:a,latestEvent:l,eventCount:o})})),s},similar:([e,t])=>{const s=((e={})=>!Object.keys(e).map((t=>e[t])).find((e=>e>=.6)))(t),r=Object.keys(t).map((e=>[e,t[e]])).reduce(((e,[t,s])=>{const[r]=String(t).split(":");return e[r]||(e[r]=[]),e[r].push([t,s]),e}),{}),i=Object.keys(r).map((e=>[e,r[e]])).reduce(((e,[t,s])=>{const r=s.filter((([,e])=>null!==e)),i=r.reduce(((e,[,t])=>e+t),0)/r.length;return e[t]=i,e}),{});return{issue:e,score:t,scoresByInterface:r,aggregate:i,isBelowThreshold:s}}};return e&&(this.toFetchArray=e),Promise.all(s).then((e=>{e.forEach((({dataKey:e,data:t,links:s})=>{const i="similar"===e?t.map(r[e]):r[e](t);this["".concat(e,"Items")]=i,this["".concat(e,"Links")]=s})),this.loading=!1,this.error=!1,this.triggerFetchState()}),(()=>{this.loading=!1,this.error=!0,this.triggerFetchState()}))},onToggleMerge(e){let t=!1;const s=this.mergeState.has(e)?this.mergeState.get(e):void 0;!0!==(null==s?void 0:s.busy)&&(this.mergeList.includes(e)?this.mergeList=this.mergeList.filter((t=>t!==e)):(this.mergeList=[...this.mergeList,e],t=!0),this.setStateForId(this.mergeState,e,{checked:t}),this.triggerMergeState())},onToggleUnmerge([e,t]){let s=!1;const r=this.unmergeState.get(e);!0!==(null==r?void 0:r.busy)&&(this.unmergeList.has(e)?this.unmergeList.delete(e):(this.unmergeList.set(e,t),s=!0),this.setStateForId(this.unmergeState,e,{checked:s}),this.unmergeDisabled=this.mergedItems.size<=1||0===this.unmergeList.size||this.isAllUnmergedSelected(),this.enableFingerprintCompare=2===this.unmergeList.size,this.triggerUnmergeState())},onUnmerge({groupId:e,loadingMessage:t,successMessage:s,errorMessage:r}){const i=Array.from(this.unmergeList.keys());return new Promise(((n,o)=>{this.isAllUnmergedSelected()?o(new Error("Not allowed to unmerge ALL events")):(this.unmergeDisabled=!0,this.setStateForId(this.unmergeState,i,{checked:!1,busy:!0}),this.triggerUnmergeState(),(0,l.E3)(t),this.api.request("/issues/".concat(e,"/hashes/"),{method:"DELETE",query:{id:i},success:()=>{(0,l.S9)(s),this.setStateForId(this.unmergeState,i,{checked:!1,busy:!0}),this.unmergeList.clear()},error:()=>{(0,l.Iw)(r),this.setStateForId(this.unmergeState,i,{checked:!0,busy:!1})},complete:()=>{this.unmergeDisabled=!1,n(this.triggerUnmergeState())}}))}))},onMerge({params:e,query:t,projectId:s}){if(!e)return;const r=this.mergeList;return this.mergeDisabled=!0,this.setStateForId(this.mergeState,r,{busy:!0}),this.triggerMergeState(),new Promise((i=>{const{orgId:n,groupId:o}=e;(0,a.fr)(this.api,{orgId:n,projectId:s||e.projectId,itemIds:[...r,o],query:t},{success:e=>{var t;null!=e&&null!==(t=e.merge)&&void 0!==t&&t.parent&&this.trigger({mergedParent:e.merge.parent}),this.setStateForId(this.mergeState,r,{checked:!1,busy:!0}),this.mergeList=[]},error:()=>{this.setStateForId(this.mergeState,r,{checked:!0,busy:!1})},complete:()=>{this.mergeDisabled=!1,i(this.triggerMergeState())}})}))},onToggleCollapseFingerprints(){this.setStateForId(this.unmergeState,this.mergedItems.map((({id:e})=>e)),{collapsed:!this.unmergeLastCollapsed}),this.unmergeLastCollapsed=!this.unmergeLastCollapsed,this.trigger({unmergeLastCollapsed:this.unmergeLastCollapsed,unmergeState:this.unmergeState})},onToggleCollapseFingerprint(e){const t=this.unmergeState.has(e)&&this.unmergeState.get(e).collapsed;this.setStateForId(this.unmergeState,e,{collapsed:!t}),this.trigger({unmergeState:this.unmergeState})},triggerFetchState(){const e={similarItems:this.similarItems.filter((({isBelowThreshold:e})=>!e)),filteredSimilarItems:this.similarItems.filter((({isBelowThreshold:e})=>e)),...i()(this,["mergedItems","mergedLinks","similarLinks","mergeState","unmergeState","loading","error","enableFingerprintCompare","unmergeList"])};return this.trigger(e),e},triggerUnmergeState(){const e=i()(this,["unmergeDisabled","unmergeState","unmergeList","enableFingerprintCompare","unmergeLastCollapsed"]);return this.trigger(e),e},triggerMergeState(){const e=i()(this,["mergeDisabled","mergeState","mergeList"]);return this.trigger(e),e}},h=o().createStore(p)},"./app/views/organizationGroupDetails/groupMerged/index.tsx":(e,t,s)=>{s.r(t),s.d(t,{GroupMergedView:()=>O,default:()=>K});var r=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/react/index.js")),n=s("../node_modules/query-string/index.js"),o=s("./app/actions/groupingActions.tsx"),a=s("./app/components/alert.tsx"),l=s("./app/components/loadingError.tsx"),g=s("./app/components/loadingIndicator.tsx"),d=s("./app/locale.tsx"),p=s("./app/stores/groupingStore.tsx"),h=s("./app/utils/callIfFunction.tsx"),m=s("./app/utils/withOrganization.tsx"),c=s("./app/components/emptyStateWarning.tsx"),u=s("./app/components/pagination.tsx"),b=s("./app/components/panels/index.tsx"),Z=s("./app/components/queryCount.tsx"),y=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),S=s("./app/components/checkbox.tsx"),f=s("./app/components/eventOrGroupHeader.tsx"),I=s("./app/components/tooltip.tsx"),C=s("./app/icons/index.tsx"),v=s("./app/styles/space.tsx"),L=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class x extends i.Component{constructor(...e){super(...e),(0,r.Z)(this,"state",{collapsed:!1,checked:!1,busy:!1}),(0,r.Z)(this,"listener",p.Z.listen((e=>this.onGroupChange(e)),void 0)),(0,r.Z)(this,"onGroupChange",(({unmergeState:e})=>{if(!e)return;const{fingerprint:t}=this.props,s=e.has(t.id)?e.get(t.id):void 0;s&&Object.keys(s).forEach((e=>{s[e]!==this.state[e]&&this.setState((t=>({...t,[e]:s[e]})))}))})),(0,r.Z)(this,"handleToggleEvents",(()=>{const{fingerprint:e}=this.props;o.Z.toggleCollapseFingerprint(e.id)})),(0,r.Z)(this,"handleToggle",(()=>{const{fingerprint:e}=this.props,{latestEvent:t}=e;this.state.busy||o.Z.toggleUnmerge([e.id,t.id])}))}handleLabelClick(e){e.preventDefault()}handleCheckClick(){}renderFingerprint(e,t){return t?(0,L.tZ)(I.Z,{title:e,children:(0,L.tZ)("code",{children:t})}):e}render(){const{fingerprint:e,organization:t}=this.props,{latestEvent:s,id:r,label:i}=e,{collapsed:n,busy:o,checked:a}=this.state,l=o;return(0,L.BX)(k,{busy:o,children:[(0,L.BX)(F,{expanded:!n,children:[(0,L.BX)(w,{onClick:this.handleToggle,children:[(0,L.tZ)(S.Z,{id:r,value:r,checked:a,disabled:l,onChange:this.handleCheckClick}),(0,L.tZ)(j,{onClick:this.handleLabelClick,htmlFor:r,children:this.renderFingerprint(r,i)})]}),(0,L.tZ)("div",{children:(0,L.tZ)(M,{onClick:this.handleToggleEvents,children:(0,L.tZ)(C.g6,{direction:n?"down":"up",size:"xs"})})})]}),!n&&(0,L.tZ)(D,{className:"event-list",children:s&&(0,L.tZ)(E,{className:"event-details",children:(0,L.tZ)(f.Z,{data:s,organization:t,hideIcons:!0,hideLevel:!0})})})]})}}x.displayName="MergedItem";const k=(0,y.Z)("div",{target:"e2itrlr6"})((e=>e.busy&&"opacity: 0.2"),";"),w=(0,y.Z)("div",{target:"e2itrlr5"})("display:grid;grid-auto-flow:column;align-items:center;gap:",(0,v.Z)(1),";input[type='checkbox']{margin:0;}"),F=(0,y.Z)("div",{target:"e2itrlr4"})("display:flex;justify-content:space-between;border-top:1px solid ",(e=>e.theme.innerBorder),";background-color:",(e=>e.theme.backgroundSecondary),";padding:",(0,v.Z)(.5)," ",(0,v.Z)(1),";",(e=>e.expanded&&"border-bottom: 1px solid ".concat(e.theme.innerBorder)),";",k,"{&:first-child &{border-top:none;}&:last-child &{border-top:none;border-bottom:1px solid ",(e=>e.theme.innerBorder),";}}"),j=(0,y.Z)("label",{target:"e2itrlr3"})("font-family:",(e=>e.theme.text.familyMono),";",F," &{font-weight:400;margin:0;}"),M=(0,y.Z)("span",{target:"e2itrlr2"})({name:"e0dnmk",styles:"cursor:pointer"}),D=(0,y.Z)("div",{target:"e2itrlr1"})("overflow:hidden;border:none;background-color:",(e=>e.theme.background),";"),E=(0,y.Z)("div",{target:"e2itrlr0"})("display:flex;justify-content:space-between;.event-list &{padding:",(0,v.Z)(1),";}"),U=x;var q=s("../node_modules/lodash/pick.js"),T=s.n(q),A=s("./app/actionCreators/modal.tsx"),_=s("./app/components/button.tsx"),B=s("./app/components/confirm.tsx");class z extends i.Component{constructor(...e){super(...e),(0,r.Z)(this,"state",this.getInitialState()),(0,r.Z)(this,"listener",p.Z.listen((e=>this.onGroupChange(e)),void 0)),(0,r.Z)(this,"onGroupChange",(e=>{this.setState(T()(e,["unmergeLastCollapsed","unmergeDisabled","unmergeList","enableFingerprintCompare"]))})),(0,r.Z)(this,"handleShowDiff",(e=>{const{groupId:t,project:s,orgId:r}=this.props,{unmergeList:i}=this.state,n=i.entries();if(2!==i.size)return;const[o,a]=Array.from(n).map((([,e])=>e));(0,A.openDiffModal)({targetIssueId:t,project:s,baseIssueId:t,orgId:r,baseEventId:o,targetEventId:a}),e.stopPropagation()}))}getInitialState(){const{unmergeList:e,unmergeLastCollapsed:t,unmergeDisabled:s,enableFingerprintCompare:r}=p.Z;return{enableFingerprintCompare:r,unmergeList:e,unmergeLastCollapsed:t,unmergeDisabled:s}}componentWillUnmount(){var e;null===(e=this.listener)||void 0===e||e.call(this)}render(){const{onUnmerge:e,onToggleCollapse:t}=this.props,{unmergeList:s,unmergeLastCollapsed:r,unmergeDisabled:i,enableFingerprintCompare:n}=this.state,o=s&&s.size||0;return(0,L.BX)(b.V9,{hasButtons:!0,children:[(0,L.BX)("div",{children:[(0,L.tZ)(B.Z,{disabled:i,onConfirm:e,message:(0,d.t)("These events will be unmerged and grouped into a new issue. Are you sure you want to unmerge these events?"),children:(0,L.BX)(_.ZP,{size:"small",title:(0,d._N)("Unmerging [unmergeCount] events",{unmergeCount:o}),children:[(0,d.t)("Unmerge")," (",o||0,")"]})}),(0,L.tZ)(G,{size:"small",disabled:!n,onClick:this.handleShowDiff,children:(0,d.t)("Compare")})]}),(0,L.tZ)(_.ZP,{size:"small",onClick:t,children:r?(0,d.t)("Expand All"):(0,d.t)("Collapse All")})]})}}z.displayName="MergedToolbar";const P=z,G=(0,y.Z)(_.ZP,{target:"e9vanab0"})("margin-left:",(0,v.Z)(1),";");function N({fingerprints:e=[],pageLinks:t,onToggleCollapse:s,onUnmerge:r,organization:n,groupId:o,project:a}){const l=e.filter((({latestEvent:e})=>!!e));return l.length>0?(0,L.BX)(i.Fragment,{children:[(0,L.BX)("h2",{children:[(0,L.tZ)("span",{children:(0,d.t)("Merged fingerprints with latest event")})," ",(0,L.tZ)(Z.Z,{count:l.length})]}),(0,L.BX)(b.s_,{children:[(0,L.tZ)(P,{onToggleCollapse:s,onUnmerge:r,orgId:n.slug,project:a,groupId:o}),(0,L.tZ)(b.N,{children:l.map((e=>(0,L.tZ)(U,{organization:n,fingerprint:e},e.id)))})]}),t&&(0,L.tZ)(u.Z,{pageLinks:t})]}):(0,L.tZ)(b.s_,{children:(0,L.tZ)(c.Z,{children:(0,L.tZ)("p",{children:(0,d.t)("There don't seem to be any hashes for this issue.")})})})}N.displayName="MergedList";const X=(0,m.Z)(N);class O extends i.Component{constructor(...e){super(...e),(0,r.Z)(this,"state",{mergedItems:[],loading:!0,error:!1,query:this.props.location.query.query||""}),(0,r.Z)(this,"onGroupingChange",(({mergedItems:e,mergedLinks:t,loading:s,error:r})=>{e&&this.setState({mergedItems:e,mergedLinks:t,loading:void 0!==s&&s,error:void 0!==r&&r})})),(0,r.Z)(this,"listener",p.Z.listen(this.onGroupingChange,void 0)),(0,r.Z)(this,"fetchData",(()=>{o.Z.fetch([{endpoint:this.getEndpoint(),dataKey:"merged",queryParams:this.props.location.query}])})),(0,r.Z)(this,"handleUnmerge",(()=>{o.Z.unmerge({groupId:this.props.params.groupId,loadingMessage:(0,d.t)("Unmerging eventsâ€¦"),successMessage:(0,d.t)("Events successfully queued for unmerging."),errorMessage:(0,d.t)("Unable to queue events for unmerging.")})}))}componentDidMount(){this.fetchData()}componentWillReceiveProps(e){if(e.params.groupId!==this.props.params.groupId||e.location.search!==this.props.location.search){const t=e.location.query;this.setState({query:t.query},this.fetchData)}}componentWillUnmount(){(0,h.g)(this.listener)}getEndpoint(){const{params:e,location:t}=this.props,{groupId:s}=e,r={...t.query,limit:50,query:this.state.query};return"/issues/".concat(s,"/hashes/?").concat(n.stringify(r))}render(){const{project:e,params:t}=this.props,{groupId:s}=t,{loading:r,error:n,mergedItems:p,mergedLinks:h}=this.state,m=n&&!r,c=!m&&!r;return(0,L.BX)(i.Fragment,{children:[(0,L.tZ)(a.Z,{type:"warning",children:(0,d.t)("This is an experimental feature. Data may not be immediately available while we process unmerges.")}),r&&(0,L.tZ)(g.Z,{}),m&&(0,L.tZ)(l.Z,{message:(0,d.t)("Unable to load merged events, please try again later"),onRetry:this.fetchData}),c&&(0,L.tZ)(X,{project:e,fingerprints:p,pageLinks:h,groupId:s,onUnmerge:this.handleUnmerge,onToggleCollapse:o.Z.toggleCollapseFingerprints})]})}}O.displayName="GroupMergedView";const K=(0,m.Z)(O)}}]);
//# sourceMappingURL=../sourcemaps/app_views_organizationGroupDetails_groupMerged_index_tsx.07666e467858f90bca8f7dc8662cc157.js.map