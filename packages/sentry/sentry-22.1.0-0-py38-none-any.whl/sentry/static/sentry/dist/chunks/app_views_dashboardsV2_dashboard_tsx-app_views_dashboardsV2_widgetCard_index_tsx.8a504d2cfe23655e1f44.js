"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["app_views_dashboardsV2_dashboard_tsx-app_views_dashboardsV2_widgetCard_index_tsx"],{"./app/actionCreators/events.tsx":(e,t,s)=>{s.d(t,{lI:()=>d,eV:()=>l,JE:()=>c}),s("../node_modules/core-js/modules/es.object.from-entries.js"),s("../node_modules/core-js/modules/web.dom-collections.iterator.js");var i=s("../node_modules/lodash/pick.js"),o=s.n(i),a=s("./app/components/charts/utils.tsx"),r=s("./app/utils/getPeriod.tsx"),n=s("./app/utils/performance/constants.tsx");const d=(e,{organization:t,project:s,environment:i,team:o,period:n,start:d,end:l,interval:c,comparisonDelta:p,includePrevious:u,query:h,yAxis:g,field:m,topEvents:y,orderby:b,partial:v,withoutZerofill:f,referrer:Z,queryBatching:x,generatePathname:w,queryExtras:C})=>{var _;const E=(0,a.Sw)(u,n),S={query:{...Object.fromEntries(Object.entries({interval:c,comparisonDelta:p,project:s,environment:i,team:o,query:h,yAxis:g,field:m,topEvents:y,orderby:b,partial:v?"1":void 0,withoutZerofill:f?"1":void 0,referrer:Z||"api.organization-event-stats"}).filter((([,e])=>void 0!==e))),...(0,r.X)({period:n,start:d,end:l},{shouldDoublePeriod:E}),...C}},R=null!==(_=null==w?void 0:w(t))&&void 0!==_?_:"/organizations/".concat(t.slug,"/events-stats/");return null!=x&&x.batchRequest?x.batchRequest(e,R,S):e.requestPromise(R,S)};async function l(e,t,s){const i={...o()(s,Object.values(n.s)),query:s.query};return e.requestPromise("/organizations/".concat(t,"/events-facets/"),{query:i})}async function c(e,t,s){const i={...o()(s,Object.values(n.s)),query:s.query};return e.requestPromise("/organizations/".concat(t,"/events-meta/"),{query:i}).then((e=>e.count))}},"./app/components/charts/areaChart.tsx":(e,t,s)=>{s.d(t,{Z:()=>d});var i=s("../node_modules/react/index.js"),o=s("./app/components/charts/series/lineSeries.tsx"),a=s("./app/components/charts/baseChart.tsx"),r=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class n extends i.Component{render(){const{series:e,stacked:t,colors:s,...i}=this.props;return(0,r.tZ)(a.Z,{...i,colors:s,series:e.map((({seriesName:e,data:i,...a},r)=>function(e={}){return(0,o.Z)({...e})}({stack:t?"area":void 0,name:e,data:i.map((({name:e,value:t})=>[e,t])),lineStyle:{color:null==s?void 0:s[r],opacity:1,width:.4},areaStyle:{color:null==s?void 0:s[r],opacity:1},animation:!1,animationThreshold:1,animationDuration:0,...a})))})}}n.displayName="AreaChart";const d=n},"./app/components/charts/chartZoom.tsx":(e,t,s)=>{s.d(t,{Z:()=>m});var i=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),o=s("../node_modules/react/index.js"),a=s("../node_modules/moment/moment.js"),r=s.n(a),n=s("../node_modules/query-string/index.js"),d=s("./app/actionCreators/pageFilters.tsx"),l=s("./app/components/charts/components/dataZoomInside.tsx"),c=s("./app/components/charts/components/toolBox.tsx"),p=s("./app/utils/callIfFunction.tsx"),u=s("./app/utils/dates.tsx");const h=e=>e?r().utc(e).format(r().HTML5_FMT.DATETIME_LOCAL_SECONDS):null;class g extends o.Component{constructor(e){super(e),(0,i.Z)(this,"history",void 0),(0,i.Z)(this,"currentPeriod",void 0),(0,i.Z)(this,"zooming",null),(0,i.Z)(this,"saveCurrentPeriod",(e=>{this.currentPeriod={period:e.period,start:h(e.start),end:h(e.end)}})),(0,i.Z)(this,"setPeriod",(({period:e,start:t,end:s},i=!1)=>{const{router:o,onZoom:a,usePageDate:r}=this.props,l=h(t),c=h(s);i&&this.history.push(this.currentPeriod),(0,p.g)(a,{period:e,start:l,end:c}),this.zooming=()=>{if(r&&o){const i={...o.location.query,pageStart:t?(0,u.v5)(t):void 0,pageEnd:s?(0,u.v5)(s):void 0,pageStatsPeriod:null!=e?e:void 0};n.stringify(i)!==n.stringify(o.location.query)&&o.push({pathname:o.location.pathname,query:i})}else(0,d.dR)({period:e,start:l?(0,u.hC)(l):l,end:c?(0,u.hC)(c):c},o);this.saveCurrentPeriod({period:e,start:t,end:s})}})),(0,i.Z)(this,"handleChartReady",(e=>{(0,p.g)(this.props.onChartReady,e)})),(0,i.Z)(this,"handleZoomRestore",((e,t)=>{this.history.length&&(this.setPeriod(this.history[0]),this.history=[],(0,p.g)(this.props.onRestore,e,t))})),(0,i.Z)(this,"handleDataZoom",((e,t)=>{const s=t.getModel(),{startValue:i,endValue:o}=s._payload.batch[0];if(null===i&&null===o){const e=this.history.pop();if(!e)return;this.setPeriod(e)}else{const e=r().utc(i),t=r().utc(o);this.setPeriod({period:null,start:e,end:t},!0)}(0,p.g)(this.props.onDataZoom,e,t)})),(0,i.Z)(this,"handleChartFinished",((e,t)=>{var s;"function"==typeof this.zooming&&(this.zooming(),this.zooming=null);const i=null===(s=t._componentsViews)||void 0===s?void 0:s.find((e=>e._features&&e._features.dataZoom));i&&!i._features.dataZoom._isZoomActive&&t.dispatchAction({type:"takeGlobalCursor",key:"dataZoomSelect",dataZoomSelectActive:!0}),(0,p.g)(this.props.onFinished)})),this.history=[],this.saveCurrentPeriod(e)}componentDidUpdate(){this.props.disabled||this.saveCurrentPeriod(this.props)}render(){const{utc:e,start:t,end:s,disabled:i,children:o,xAxisIndex:a,router:r,onZoom:n,onRestore:d,onChartReady:p,onDataZoom:h,onFinished:g,...m}=this.props,y=null!=e?e:void 0,b=t?(0,u.hC)(t):void 0,v=s?(0,u.hC)(s):void 0;return o(i?{utc:y,start:b,end:v,...m}:{isGroupedByDate:!0,onChartReady:this.handleChartReady,utc:y,start:b,end:v,dataZoom:(0,l.Z)({xAxisIndex:a}),showTimeInTooltip:!0,toolBox:(0,c.Z)({},{dataZoom:{title:{zoom:"",back:""},iconStyle:{borderWidth:0,color:"transparent",opacity:0}}}),onDataZoom:this.handleDataZoom,onFinished:this.handleChartFinished,onRestore:this.handleZoomRestore,...m})}}g.displayName="ChartZoom";const m=g},"./app/components/charts/components/visualMap.tsx":(e,t,s)=>{function i(e){return e}s.d(t,{Z:()=>i}),s("../node_modules/echarts/lib/component/visualMap.js")},"./app/components/charts/lineChart.tsx":(e,t,s)=>{s.d(t,{Z:()=>n}),s("../node_modules/react/index.js");var i=s("./app/components/charts/series/lineSeries.tsx"),o=s("./app/components/charts/baseChart.tsx"),a=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function r({series:e,seriesOptions:t,...s}){return(0,a.tZ)(o.Z,{...s,series:e.map((({seriesName:e,data:s,dataArray:o,...a})=>(0,i.Z)({...t,...a,name:e,data:o||(null==s?void 0:s.map((({value:e,name:t})=>[t,e]))),animation:!1,animationThreshold:1,animationDuration:0})))})}r.displayName="LineChart";const n=r},"./app/components/charts/transitionChart.tsx":(e,t,s)=>{s.d(t,{Z:()=>d});var i=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),o=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/react/index.js")),a=s("./app/components/charts/loadingPanel.tsx"),r=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class n extends o.Component{constructor(...e){super(...e),(0,i.Z)(this,"state",{prevReloading:this.props.reloading,prevLoading:this.props.loading,key:1})}static getDerivedStateFromProps(e,t){const s=t.prevReloading,i=e.reloading,o=t.prevLoading,a=e.loading;return o!==a?{prevReloading:i,prevLoading:a,key:t.key+1}:a?{prevReloading:i,prevLoading:a,key:t.key}:s&&!i?{prevReloading:i,prevLoading:a,key:t.key+1}:{prevReloading:i,prevLoading:a,key:t.key}}render(){const{height:e,loading:t,reloading:s}=this.props;return t&&!s?(0,r.tZ)(a.Z,{height:e,"data-test-id":"events-request-loading"}):(0,r.tZ)(o.Fragment,{children:this.props.children},String(this.state.key))}}n.displayName="TransitionChart",(0,i.Z)(n,"defaultProps",{height:"200px"});const d=n},"./app/components/charts/transparentLoadingMask.tsx":(e,t,s)=>{s.d(t,{Z:()=>r});var i=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),o=(s("../node_modules/react/index.js"),s("./app/components/loadingMask.tsx")),a=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const r=(0,i.Z)((({className:e,visible:t,children:s,...i})=>{const r=t?{...i,"data-test-id":"loading-placeholder"}:i;return(0,a.tZ)(o.Z,{className:e,...r,children:s})}),{target:"ewtkxp50"})((e=>!e.visible&&"display: none;"),";opacity:0.4;z-index:1;")},"./app/components/charts/worldMapChart.tsx":(e,t,s)=>{s.d(t,{Z:()=>g});var i=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),o=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/core-js/modules/es.object.from-entries.js"),s("../node_modules/react/index.js")),a=s("../node_modules/@emotion/react/dist/emotion-element-a8309070.browser.esm.js"),r=s("../node_modules/echarts/lib/core/echarts.js"),n=s("../node_modules/lodash/max.js"),d=s.n(n),l=s("./app/components/charts/components/visualMap.tsx");s("../node_modules/echarts/lib/chart/map.js");var c=s("./app/components/charts/baseChart.tsx"),p=s("./app/components/charts/utils.tsx"),u=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class h extends o.Component{constructor(...e){super(...e),(0,i.Z)(this,"state",{countryToCodeMap:null,map:null,codeToCountryMap:null})}async componentDidMount(){const[e,t]=await Promise.all([s.e("app_data_countryCodesMap_tsx").then(s.bind(s,"./app/data/countryCodesMap.tsx")),s.e("app_data_world_json").then(s.t.bind(s,"./app/data/world.json",19))]);r.je("sentryWorld",t.default),this.setState({countryToCodeMap:e.default,map:t.default,codeToCountryMap:Object.fromEntries(Object.entries(e.default).map((([e,t])=>[t,e])))})}render(){const{countryToCodeMap:e,map:t}=this.state;if(null===e||null===t)return null;const{series:s,seriesOptions:i,theme:o,fromDiscover:a,fromDiscoverQueryList:r,...n}=this.props,h=s.map((({seriesName:e,data:t,...s})=>{var n;return function(e={map:""}){return{roam:!0,...e,emphasis:{label:{show:!1},...e.emphasis},type:"map"}}({...i,...s,map:"sentryWorld",name:e,nameMap:null!==(n=this.state.countryToCodeMap)&&void 0!==n?n:void 0,aspectScale:.85,zoom:a?1.1:r?.9:1.3,center:[10.97,r?-12:9.71],itemStyle:{areaColor:o.gray200,borderColor:o.backgroundSecondary},emphasis:{itemStyle:{areaColor:o.pink300},label:{show:!1}},data:t,silent:r,roam:!r})})),g=d()(s.map((({data:e})=>d()(e.map((({value:e})=>e))))))||1;return(0,u.tZ)(c.Z,{options:{backgroundColor:r?void 0:o.background,visualMap:[(0,l.Z)({show:!r,left:a?void 0:"right",right:a?5:void 0,min:0,max:g,inRange:{color:[o.purple200,o.purple300]},text:["High","Low"],textStyle:{color:o.textColor},calculable:!1})]},...n,yAxis:null,xAxis:null,series:h,tooltip:{formatter:e=>{var t;const{marker:s,name:i,value:o}=Array.isArray(e)?e[0]:e;if(isNaN(o))return"";const a="number"==typeof o?o.toLocaleString():"",r=(null===(t=this.state.codeToCountryMap)||void 0===t?void 0:t[i])||i;return['<div class="tooltip-series tooltip-series-solo">\n                 <div><span class="tooltip-label">'.concat(s," <strong>").concat(r,"</strong></span> ").concat(a,"</div>\n              </div>"),(0,p.U8)()].join("")}},height:a?400:void 0})}}h.displayName="WorldMapChart";const g=(0,a.b)(h)},"./app/utils/discover/charts.tsx":(e,t,s)=>{s.d(t,{CX:()=>n,gu:()=>d});var i=s("./app/locale.tsx"),o=s("./app/utils.tsx"),a=s("./app/utils/discover/fields.tsx"),r=s("./app/utils/formatters.tsx");function n(e,t=""){if(!(0,o.ri)(e))return"—";switch((0,a.Px)(t)){case"integer":case"number":return e.toLocaleString();case"percentage":return(0,r.rl)(e,2);case"duration":return(0,r.g9)(e/1e3,2,!0);default:return e.toString()}}function d(e,t,s=!1){switch((0,a.Px)(t)){case"integer":case"number":return s?(0,r.Du)(e):e.toLocaleString();case"percentage":return(0,r.rl)(e,0);case"duration":return function(e){if(0===e)return"0";if(e>=r.ps){const t=(e/r.ps).toFixed(0);return(0,i.t)("%swk",t)}if(e>=r.x4){const t=(e/r.x4).toFixed(0);return(0,i.t)("%sd",t)}if(e>=r.kr){const t=(e/r.kr).toFixed(0);return(0,i.t)("%shr",t)}if(e>=r.EB){const t=(e/r.EB).toFixed(0);return(0,i.t)("%smin",t)}if(e>=r.sh){const t=(e/r.sh).toFixed(0);return(0,i.t)("%ss",t)}const t=e.toFixed(0);return(0,i.t)("%sms",t)}(e);default:return e.toString()}}},"./app/utils/getPeriod.tsx":(e,t,s)=>{s.d(t,{X:()=>n}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js");var i=s("../node_modules/moment/moment.js"),o=s.n(i),a=s("./app/constants/index.tsx"),r=s("./app/utils/dates.tsx");const n=({period:e,start:t,end:s},{shouldDoublePeriod:i}={})=>{if(e||t||s||(e=a.GY),e){if(!i)return{statsPeriod:e};const[,t,s]=e.match(/([0-9]+)([mhdw])/);return{statsPeriod:"".concat(2*parseInt(t,10)).concat(s)}}if(!t||!s)throw new Error("start and end required");const n=(0,r.v5)(t),d=(0,r.v5)(s);if(i){const e=o()(s).diff(o()(t)),i=o()(t).subtract(e);return{start:(0,r.v5)(i),end:d}}return{start:n,end:d}}},"./app/views/dashboardsV2/dashboard.tsx":(e,t,s)=>{s.d(t,{re:()=>H,TE:()=>de,Yb:()=>ne,ZP:()=>se});var i=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),o=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),a=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/react-grid-layout/css/styles.css"),s("../node_modules/react-resizable/css/styles.css"),s("../node_modules/react/index.js")),r=s("../node_modules/react-grid-layout/index.js"),n=s("../node_modules/@dnd-kit/core/dist/core.esm.js"),d=s("../node_modules/@dnd-kit/sortable/dist/sortable.esm.js"),l=s("../node_modules/lodash/cloneDeep.js"),c=s.n(l),p=s("../node_modules/lodash/isEqual.js"),u=s.n(p),h=s("../node_modules/lodash/sortBy.js"),g=s.n(h),m=s("../node_modules/lodash/zip.js"),y=s.n(m),b=s("./app/actionCreators/dashboards.tsx"),v=s("./app/actionCreators/indicator.tsx"),f=s("./app/actionCreators/members.tsx"),Z=s("./app/actionCreators/modal.tsx"),x=s("./app/actionCreators/tags.tsx"),w=s("./app/styles/space.tsx"),C=s("./app/utils/analytics/trackAdvancedAnalyticsEvent.tsx");if("app"==s.j)var _=s("./app/utils/guid.tsx");var E=s("./app/utils/theme.tsx"),S=s("./app/utils/withApi.tsx"),R=s("./app/utils/withPageFilters.tsx"),D=s("./app/views/dashboardsV2/widget/utils.tsx"),T=s("./app/components/button.tsx"),j=s("./app/icons/index.tsx"),M=s("./app/views/dashboardsV2/types.tsx"),z=s("../node_modules/framer-motion/dist/es/render/dom/motion.js");const A=(0,o.Z)(z.E.div,{target:"ec3gecx0"})("position:relative;touch-action:manipulation;",(e=>{switch(e.displayType){case"big_number":return"\n          /* 2 cols */\n          grid-area: span 1 / span 2;\n\n          @media (min-width: ".concat(e.theme.breakpoints[0],") {\n            /* 4 cols */\n            grid-area: span 1 / span 1;\n          }\n\n          @media (min-width: ").concat(e.theme.breakpoints[3],") {\n            /* 6 and 8 cols */\n            grid-area: span 1 / span 2;\n          }\n        ");default:return"\n          /* 2, 4, 6 and 8 cols */\n          grid-area: span 2 / span 2;\n        "}}),";");var k=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const L="add-widget-button",I={x:0,y:0,scaleX:1,scaleY:1};function N({onAddWidget:e,onOpenWidgetBuilder:t,orgFeatures:s}){const i=s.includes("metrics")&&s.includes("metrics-dashboards-ui")?t:e,{setNodeRef:o,transform:a}=(0,d.nB)({disabled:!0,id:L,transition:null});return(0,k.tZ)(A,{ref:o,displayType:M.FO.BIG_NUMBER,layoutId:L,style:{originX:0,originY:0},animate:a?{x:a.x,y:a.y,scaleX:null!=a&&a.scaleX&&a.scaleX<=1?a.scaleX:1,scaleY:null!=a&&a.scaleY&&a.scaleY<=1?a.scaleY:1}:I,transition:{duration:.25},children:(0,k.tZ)(W,{onClick:i,children:(0,k.tZ)(P,{"data-test-id":"widget-add",icon:(0,k.tZ)(j.N_,{size:"lg",isCircled:!0,color:"inactive"})})})},"add")}N.displayName="AddWidget";const q=N,P=(0,o.Z)(T.ZP,{target:"e1sxcph31"})({name:"6ayxgl",styles:"border:none;&,&:focus,&:active,&:hover{background:transparent;box-shadow:none;}"}),W=(0,o.Z)("div",{target:"e1sxcph30"})("width:100%;height:110px;border:2px dashed ",(e=>e.theme.border),";border-radius:",(e=>e.theme.borderRadius),";display:flex;align-items:center;justify-content:center;cursor:",(e=>e.onClick?"pointer":""),";");var B=s("./app/utils/withOrganization.tsx"),O=s("./app/views/dashboardsV2/widgetCard/index.tsx");function F(e){const{organization:t,widget:s,dragId:i,isEditing:o,widgetLimitReached:r,hideDragHandle:n,onDelete:l,onEdit:c,onDuplicate:p,isPreview:u}=e,{attributes:h,listeners:g,setNodeRef:m,transform:y,isDragging:b,isSorting:v}=(0,d.nB)({id:i,transition:null});(0,a.useEffect)((()=>{if(b)return document.body.style.cursor="grabbing",function(){document.body.style.cursor=""}}),[b]);let f={widget:s,isEditing:o,widgetLimitReached:r,onDelete:l,onEdit:c,onDuplicate:p,isSorting:v,hideToolbar:v,currentWidgetDragging:b,showContextMenu:!0,isPreview:u};return t.features.includes("dashboard-grid-layout")?(f={...f,hideDragHandle:n,isSorting:!1,currentWidgetDragging:!1},(0,k.tZ)(V,{children:(0,k.tZ)(O.Z,{...f})})):(f={...f,draggableProps:{attributes:h,listeners:g}},(0,k.tZ)(A,{ref:m,displayType:s.displayType,layoutId:i,style:{originX:b?1:0,originY:0,boxShadow:b?E.ZP.dropShadowHeavy:"none",borderRadius:b?E.ZP.borderRadius:void 0},animate:y?{x:y.x,y:y.y,scaleX:null!=y&&y.scaleX&&y.scaleX<=1?y.scaleX:1,scaleY:null!=y&&y.scaleY&&y.scaleY<=1?y.scaleY:1,zIndex:b?E.ZP.zIndex.modal:"auto"}:{zIndex:"auto"},transformTemplate:(e,t)=>o&&y?t:"none",transition:{duration:b?0:.25,easings:{type:"spring"}},children:(0,k.tZ)(O.Z,{...f})}))}F.displayName="SortableWidget";const U=(0,B.Z)(F),V=(0,o.Z)("div",{target:"e12vujy00"})({name:"13udsys",styles:"height:100%"});var X=s("../node_modules/@emotion/react/dist/emotion-react.browser.esm.js");const H="widget-drag",Y="desktop",G="mobile",K=[16,16],Q={x:0,y:Number.MAX_VALUE,w:2,h:1,isResizable:!1},J=parseInt(E.ZP.breakpoints[0],10),$={[G]:0,[Y]:J},ee={[G]:2,[Y]:6};class te extends a.Component{constructor(e){super(e),(0,i.Z)(this,"handleStartAdd",(()=>{const{organization:e,dashboard:t,selection:s,handleUpdateWidgetList:i,handleAddCustomWidget:o}=this.props;if((0,C.Z)("dashboards_views.add_widget_modal.opened",{organization:e}),e.features.includes("widget-library"))return(0,C.Z)("dashboards_views.widget_library.opened",{organization:e}),void(0,Z.openAddDashboardWidgetModal)({organization:e,dashboard:t,selection:s,onAddWidget:o,onAddLibraryWidget:e=>i(e),source:M.EN.LIBRARY});(0,Z.openAddDashboardWidgetModal)({organization:e,dashboard:t,selection:s,onAddWidget:o,source:M.EN.DASHBOARDS})})),(0,i.Z)(this,"handleOpenWidgetBuilder",(()=>{const{router:e,paramDashboardId:t,organization:s,location:i}=this.props;t?e.push({pathname:"/organizations/".concat(s.slug,"/dashboard/").concat(t,"/widget/new/"),query:{...i.query,dataSet:D.qg.EVENTS}}):e.push({pathname:"/organizations/".concat(s.slug,"/dashboards/new/widget/new/"),query:{...i.query,dataSet:D.qg.EVENTS}})})),(0,i.Z)(this,"handleUpdateComplete",(e=>t=>{const{isEditing:s,handleUpdateWidgetList:i}=this.props,o=[...this.props.dashboard.widgets],a=o.indexOf(e);o[a]={...t,tempId:e.tempId},this.props.onUpdate(o),s||i(o)})),(0,i.Z)(this,"handleDeleteWidget",(e=>()=>{const{layouts:t}=this.state,{dashboard:s,onUpdate:i,onLayoutChange:o,organization:a,isEditing:r,handleUpdateWidgetList:n}=this.props,d=s.widgets.filter((t=>t!==e));i(d),a.features.includes("dashboard-grid-layout")&&o(t.desktop.filter((({i:t})=>t!==ne(e)))),r||n(d)})),(0,i.Z)(this,"handleDuplicateWidget",((e,t)=>()=>{const{dashboard:s,isEditing:i,handleUpdateWidgetList:o}=this.props,a=c()(e);a.id=void 0,a.tempId=void 0;const r=[...s.widgets];r.splice(t,0,a),i||o(r)})),(0,i.Z)(this,"handleEditWidget",((e,t)=>()=>{const{organization:s,dashboard:i,selection:o,router:a,location:r,paramDashboardId:n,onSetWidgetToBeUpdated:d,handleAddCustomWidget:l}=this.props;if(s.features.includes("metrics")&&s.features.includes("metrics-dashboards-ui")){if(d(e),n)return void a.push({pathname:"/organizations/".concat(s.slug,"/dashboard/").concat(n,"/widget/").concat(t,"/edit/"),query:{...r.query,dataSet:D.qg.EVENTS}});a.push({pathname:"/organizations/".concat(s.slug,"/dashboards/new/widget/").concat(t,"/edit/"),query:{...r.query,dataSet:D.qg.EVENTS}})}(0,C.Z)("dashboards_views.edit_widget_modal.opened",{organization:s});const c={organization:s,widget:e,selection:o,onAddWidget:l,onUpdateWidget:this.handleUpdateComplete(e)};(0,Z.openAddDashboardWidgetModal)({...c,dashboard:i,source:M.EN.DASHBOARDS})})),(0,i.Z)(this,"handleLayoutChange",((e,t)=>{const{onLayoutChange:s}=this.props,i=({i:e})=>e!==L,o={[Y]:t.desktop.filter(i),[G]:t.mobile.filter(i)};this.setState({layouts:o}),s(o.desktop)})),(0,i.Z)(this,"handleBreakpointChange",(e=>{const{layouts:t}=this.state,{dashboard:{widgets:s}}=this.props;e!==G?this.setState({isMobile:!1}):this.setState({isMobile:!0,layouts:{...t,[G]:ce(t.desktop,s)}})})),(0,i.Z)(this,"renderDndDashboard",(()=>{const{isEditing:e,onUpdate:t,dashboard:s,organization:i,widgetLimitReached:o}=this.props;let{widgets:a}=s;i.features.includes("issues-in-dashboards")||(a=a.filter((({widgetType:e})=>e!==M.l9.ISSUE)));const r=this.getWidgetIds();return(0,k.tZ)(n.LB,{collisionDetection:n.pE,onDragEnd:({over:e,active:s})=>{const i=s.id,o=r.indexOf.bind(r),n=i?o(i):-1;if(e&&e.id!==L){const s=o(e.id);n!==s&&t((0,d.Rp)(a,n,s))}},children:(0,k.tZ)(ie,{children:(0,k.BX)(d.Fo,{items:r,strategy:d.U2,children:[a.map(((e,t)=>this.renderWidget(e,t))),e&&!o&&(0,k.tZ)(q,{orgFeatures:i.features,onAddWidget:this.handleStartAdd,onOpenWidgetBuilder:this.handleOpenWidgetBuilder})]})})})}));const{layout:t,dashboard:s,organization:o}=e,a=o.features.includes("dashboard-grid-layout");this.state={isMobile:!1,layouts:{[Y]:a?t:[],[G]:a?ce(t,s.widgets):[]}}}static getDerivedStateFromProps(e,t){return e.organization.features.includes("dashboard-grid-layout")&&!u()(e.layout,t.layouts.desktop)?{...t,layouts:{[Y]:e.layout,[G]:ce(e.layout,e.dashboard.widgets)}}:null}async componentDidMount(){const{isEditing:e}=this.props;e&&this.fetchTags(),this.addNewWidget(),this.fetchMemberList()}async componentDidUpdate(e){const{isEditing:t,newWidget:s}=this.props;e.isEditing!==t&&t&&this.fetchTags(),s!==e.newWidget&&this.addNewWidget(),u()(e.selection.projects,this.props.selection.projects)||this.fetchMemberList()}fetchMemberList(){var e;const{api:t,selection:s}=this.props;(0,f.MA)(t,this.props.organization.slug,null===(e=s.projects)||void 0===e?void 0:e.map((e=>String(e))))}async addNewWidget(){const{api:e,organization:t,newWidget:s,handleAddCustomWidget:i}=this.props;if(s)try{await(0,b.QL)(e,t.slug,s),i(s)}catch(e){(0,v.Iw)(e)}}fetchTags(){const{api:e,organization:t,selection:s}=this.props;(0,x.QK)(e,t.slug,s)}getWidgetIds(){return[...this.props.dashboard.widgets.map(((e,t)=>re(e,t))),L]}renderWidget(e,t){const{isMobile:s}=this.state,{isEditing:i,organization:o,widgetLimitReached:a,isPreview:r}=this.props,n={widget:e,isEditing:i,widgetLimitReached:a,onDelete:this.handleDeleteWidget(e),onEdit:this.handleEditWidget(e,t),onDuplicate:this.handleDuplicateWidget(e,t),isPreview:r};if(o.features.includes("dashboard-grid-layout")){const i=ne(e),o=i;return(0,k.tZ)(oe,{"data-grid":le(t,e.displayType),children:(0,k.tZ)(U,{...n,dragId:o,hideDragHandle:s})},i)}const d=re(e,t),l=d;return(0,X.az)(U,{...n,key:d,dragId:l})}renderGridDashboard(){const{layouts:e,isMobile:t}=this.state,{isEditing:s,dashboard:i,organization:o,widgetLimitReached:a}=this.props;let{widgets:r}=i;o.features.includes("issues-in-dashboards")||(r=r.filter((({widgetType:e})=>e!==M.l9.ISSUE)));const n=!t&&s;return(0,k.BX)(ae,{breakpoints:$,cols:ee,rowHeight:120,margin:K,draggableHandle:".".concat(H),layouts:e,onLayoutChange:this.handleLayoutChange,onBreakpointChange:this.handleBreakpointChange,isDraggable:n,isResizable:n,isBounded:!0,children:[r.map(((e,t)=>this.renderWidget(e,t))),s&&!a&&(0,k.tZ)("div",{"data-grid":Q,children:(0,k.tZ)(q,{orgFeatures:o.features,onAddWidget:this.handleStartAdd,onOpenWidgetBuilder:this.handleOpenWidgetBuilder})},L)]})}render(){const{organization:e}=this.props;return e.features.includes("dashboard-grid-layout")?this.renderGridDashboard():this.renderDndDashboard()}}te.displayName="Dashboard";const se=(0,S.Z)((0,R.Z)(te)),ie=(0,o.Z)("div",{target:"e1wa3gzn2"})("display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));grid-auto-flow:row dense;gap:",(0,w.Z)(2),";@media (min-width: ",(e=>e.theme.breakpoints[1]),"){grid-template-columns:repeat(4, minmax(0, 1fr));}@media (min-width: ",(e=>e.theme.breakpoints[3]),"){grid-template-columns:repeat(6, minmax(0, 1fr));}@media (min-width: ",(e=>e.theme.breakpoints[4]),"){grid-template-columns:repeat(8, minmax(0, 1fr));}"),oe=(0,o.Z)("div",{target:"e1wa3gzn1"})({name:"9etigx",styles:".react-resizable-handle{z-index:1;}"}),ae=(0,o.Z)((0,r.WidthProvider)(r.Responsive),{target:"e1wa3gzn0"})({name:"vivys5",styles:".react-grid-item:hover{z-index:10;}"});function re(e,t){return e.id?"".concat(e.id,"-index-").concat(t):"index-".concat(t)}function ne(e){var t;return"".concat("grid-item","-").concat(null!==(t=e.id)&&void 0!==t?t:e.tempId)}function de(e){var t;return(null!==(t=e.id)&&void 0!==t?t:e.tempId)?e:{...e,tempId:(0,_.E)()}}function le(e,t){return{x:2*e%6,y:Number.MAX_VALUE,w:2,h:t===M.FO.BIG_NUMBER?1:2,minH:t===M.FO.BIG_NUMBER?1:2}}function ce(e,t){if(0===e.length)return[];const s=new Set(t.map(ne)),i=e.filter((({i:e})=>s.has(e))),o=y()(i,t);return g()(o,["0.y","0.x"]).map((([e,t],s)=>({...e,x:0,y:2*s,w:2,h:t.displayType===M.FO.BIG_NUMBER?1:2})))}},"./app/views/dashboardsV2/widget/issueWidget/fields.tsx":(e,t,s)=>{var i;s.d(t,{$:()=>o}),function(e){e.ASSIGNEE="assignee",e.TITLE="title",e.ISSUE="issue",e.LEVEL="level",e.STATUS="status",e.PLATFORM="platform",e.PERMALINK="permalink",e.IS_BOOKMARKED="isBookmarked",e.IS_SUBSCRIBED="isSubscribed",e.IS_HANDLED="isHandled",e.COUNT="count",e.USER_COUNT="userCount",e.LAST_SEEN="lastSeen",e.FIRST_SEEN="firstSeen",e.LIFETIME_COUNT="lifetimeCount",e.LIFETIME_USER_COUNT="lifetimeUserCount"}(i||(i={}));const o={[i.ASSIGNEE]:"string",[i.TITLE]:"string",[i.ISSUE]:"string",[i.LEVEL]:"string",[i.STATUS]:"string",[i.PLATFORM]:"string",[i.PERMALINK]:"string",[i.IS_BOOKMARKED]:"boolean",[i.IS_SUBSCRIBED]:"boolean",[i.IS_HANDLED]:"boolean",[i.COUNT]:"string",[i.USER_COUNT]:"string",[i.LAST_SEEN]:"string",[i.FIRST_SEEN]:"string",[i.LIFETIME_COUNT]:"string",[i.LIFETIME_USER_COUNT]:"string"}},"./app/views/dashboardsV2/widget/utils.tsx":(e,t,s)=>{s.d(t,{FO:()=>o,qg:()=>a,hV:()=>r});var i=s("./app/locale.tsx");let o,a;!function(e){e.AREA="area",e.BAR="bar",e.LINE="line",e.TABLE="table",e.WORLD_MAP="world_map",e.BIG_NUMBER="big_number",e.STACKED_AREA="stacked_area",e.TOP_N="top_n"}(o||(o={})),function(e){e.EVENTS="events",e.METRICS="metrics"}(a||(a={}));const r={[o.AREA]:(0,i.t)("Area Chart"),[o.BAR]:(0,i.t)("Bar Chart"),[o.LINE]:(0,i.t)("Line Chart"),[o.TABLE]:(0,i.t)("Table"),[o.WORLD_MAP]:(0,i.t)("World Map"),[o.BIG_NUMBER]:(0,i.t)("Big Number"),[o.TOP_N]:(0,i.t)("Top 5 Events")}},"./app/views/dashboardsV2/widgetCard/index.tsx":(e,t,s)=>{s.d(t,{Z:()=>Ie});var i=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),o=s("../node_modules/react/index.js"),a=s("../node_modules/react-lazyload/lib/index.js"),r=s("../node_modules/react-router/es/index.js"),n=s("./app/components/charts/errorPanel.tsx"),d=s("./app/components/panels/panelTable.tsx"),l=s("./app/styles/space.tsx"),c=s("./app/utils/discover/fieldRenderers.tsx"),p=s("./app/utils/discover/fields.tsx"),u=s("./app/utils/withOrganization.tsx"),h=s("./app/views/eventsV2/utils.tsx"),g=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class m extends o.Component{renderRow(e,t,s,i){const{location:o,organization:a}=this.props;return i.map((i=>{const r=(0,c.Js)(i.name,s)(t,{organization:a,location:o});return(0,g.tZ)(v,{children:r},"".concat(e,":").concat(i.name))}))}render(){const{className:e,loading:t,fields:s,metadata:i,data:a,title:r}=this.props,n=null!=i?i:{},d=(0,h.Hg)(s.map((e=>({field:e}))));return(0,g.BX)(o.Fragment,{children:[r&&(0,g.tZ)("h4",{children:r}),(0,g.tZ)(y,{className:e,isLoading:t,headers:d.map(((e,t)=>{const s=(0,p.qG)(e.name,e.type,n);return(0,g.tZ)(b,{align:s,children:e.name},t)})),isEmpty:!(null!=a&&a.length),disablePadding:!0,children:null==a?void 0:a.map(((e,t)=>this.renderRow(t,e,n,d)))})]})}}m.displayName="SimpleTableChart";const y=(0,i.Z)(d.Z,{target:"e3tr8vk2"})("border-radius:0;border-left:0;border-right:0;border-bottom:0;margin:0;",d.z,"{height:min-content;}"),b=(0,i.Z)("div",{target:"e3tr8vk1"})((e=>e.align?"text-align: ".concat(e.align,";"):"")," padding:",(0,l.Z)(1)," ",(0,l.Z)(3),";"),v=(0,i.Z)("div",{target:"e3tr8vk0"})("padding:",(0,l.Z)(1)," ",(0,l.Z)(3),";"),f=(0,u.Z)(m);var Z=s("./app/components/charts/styles.tsx"),x=s("./app/components/charts/transparentLoadingMask.tsx"),w=s("./app/components/errorBoundary.tsx"),C=s("./app/components/loadingIndicator.tsx"),_=s("./app/components/panels/index.tsx"),E=s("./app/components/placeholder.tsx"),S=s("./app/icons/index.tsx"),R=s("./app/locale.tsx"),D=s("./app/styles/overflowEllipsis.tsx"),T=s("./app/utils/withApi.tsx"),j=s("./app/utils/withPageFilters.tsx"),M=s("./app/views/dashboardsV2/dashboard.tsx"),z=s("./app/views/dashboardsV2/types.tsx"),A=s("./app/views/dashboardsV2/widget/issueWidget/fields.tsx"),k=s("../node_modules/@emotion/react/dist/emotion-element-a8309070.browser.esm.js"),L=s("../node_modules/lodash/isEqual.js"),I=s.n(L),N=s("./app/components/charts/areaChart.tsx"),q=s("./app/components/charts/barChart.tsx"),P=s("./app/components/charts/chartZoom.tsx"),W=s("./app/components/charts/lineChart.tsx"),B=s("./app/components/charts/transitionChart.tsx"),O=s("./app/components/charts/utils.tsx"),F=s("./app/components/charts/worldMapChart.tsx"),U=s("./app/utils/discover/charts.tsx"),V=s("./app/utils/getDynamicText.tsx");class X extends o.Component{shouldComponentUpdate(e){const t={...this.props,widget:{...this.props.widget,title:""}};return e={...e,widget:{...e.widget,title:""}},!I()(t,e)}tableResultComponent({loading:e,errorMessage:t,tableResults:s}){const{location:i,widget:o,organization:a}=this.props;return t?(0,g.tZ)(n.Z,{children:(0,g.tZ)(S.FC,{color:"gray500",size:"lg"})}):void 0===s||e?(0,g.tZ)(G,{height:"200px"}):s.map(((t,r)=>{var n,d;const l=null!==(n=null===(d=o.queries[r])||void 0===d?void 0:d.fields)&&void 0!==n?n:[];return(0,g.tZ)(J,{location:i,fields:l,title:s.length>1?t.title:"",loading:e,metadata:t.meta,data:t.data,organization:a},"table:".concat(t.title))}))}bigNumberComponent({loading:e,errorMessage:t,tableResults:s}){return t?(0,g.tZ)(n.Z,{children:(0,g.tZ)(S.FC,{color:"gray500",size:"lg"})}):void 0===s||e?(0,g.tZ)(K,{children:"—"}):s.map((e=>{var t;const s=null!==(t=e.meta)&&void 0!==t?t:{},i=Object.keys(null!=s?s:{})[0];if(!i||!e.data.length)return(0,g.tZ)(K,{children:"—"},"big_number:".concat(e.title));const o=e.data[0],a=(0,c.fK)(i,s)(o);return(0,g.tZ)(K,{children:a},"big_number:".concat(e.title))}))}chartComponent(e){const{widget:t}=this.props;switch(t.displayType){case"bar":return(0,g.tZ)(q.Z,{...e});case"area":case"top_n":return(0,g.tZ)(N.Z,{stacked:!0,...e});case"world_map":return(0,g.tZ)(F.Z,{...e});case"line":default:return(0,g.tZ)(W.Z,{...e})}}render(){var e,t,s;const{theme:i,tableResults:o,timeseriesResults:a,errorMessage:r,loading:d,widget:l,organization:c}=this.props;if("table"===l.displayType)return(0,g.BX)(B.Z,{loading:d,reloading:d,children:[(0,g.tZ)(Y,{loading:d}),this.tableResultComponent({tableResults:o,loading:d,errorMessage:r})]});if("big_number"===l.displayType)return(0,g.BX)(B.Z,{loading:d,reloading:d,children:[(0,g.tZ)(Y,{loading:d}),this.bigNumberComponent({tableResults:o,loading:d,errorMessage:r})]});if(r)return(0,g.tZ)(n.Z,{children:(0,g.tZ)(S.FC,{color:"gray500",size:"lg"})});const{location:u,router:h,selection:m}=this.props,{start:y,end:b,period:v,utc:f}=m.datetime,Z=Boolean(c.features.includes("dashboard-grid-layout")&&(l.id||l.tempId));if("world_map"===l.displayType){const{data:e,title:t}=(0,O.JT)(o),s=[{seriesName:t,data:e}];return(0,g.BX)(B.Z,{loading:d,reloading:d,children:[(0,g.tZ)(Y,{loading:d}),(0,g.tZ)(Q,{autoHeightResize:Z,children:(0,V.Z)({value:this.chartComponent({series:s,autoHeightResize:Z}),fixed:(0,g.tZ)(E.Z,{height:"200px",testId:"skeleton-ui"})})})]})}const x={left:0,top:0,selected:(0,O.RI)(u),formatter:e=>{const t=(0,p.hW)(e);if(null!==t){const s=(0,p.b8)(t);null!==s&&(e=s.toUpperCase())}return(0,p.by)(e)&&(e=(0,p.bQ)(e)),e}},w=null!==(e=null===(t=l.queries[0])||void 0===t||null===(s=t.fields)||void 0===s?void 0:s[0])&&void 0!==e?e:"count()",C={autoHeightResize:Z,grid:{left:4,right:0,top:"40px",bottom:0},seriesOptions:{showSymbol:!1},tooltip:{trigger:"axis",valueFormatter:U.CX},yAxis:{axisLabel:{color:i.chartLabel,formatter:e=>(0,U.gu)(e,w)}}};return(0,g.tZ)(P.Z,{router:h,period:v,start:y,end:b,utc:f,children:e=>{if(r)return(0,g.tZ)(n.Z,{children:(0,g.tZ)(S.FC,{color:"gray500",size:"lg"})});const t=a?i.charts.getColorPalette(a.length-2):[];"top_n"===l.displayType&&a&&a.length>5&&(t[t.length-1]=i.chartOther);const s=a?a.map(((e,s)=>({...e,color:t[s]}))):[];return(0,g.BX)(B.Z,{loading:d,reloading:d,children:[(0,g.tZ)(Y,{loading:d}),(0,g.tZ)(Q,{autoHeightResize:Z,children:(0,V.Z)({value:this.chartComponent({...e,...C,legend:x,series:s}),fixed:(0,g.tZ)(E.Z,{height:"200px",testId:"skeleton-ui"})})})]})}})}}X.displayName="WidgetCardChart";const H=(0,i.Z)((e=>(0,g.tZ)(x.Z,{...e,maskBackgroundColor:"transparent"})),{target:"eb7j3e4"})({name:"1vcob1d",styles:"display:flex;justify-content:center;align-items:center"}),Y=({loading:e})=>e?(0,g.tZ)(H,{visible:e,children:(0,g.tZ)(C.Z,{mini:!0})}):null;Y.displayName="LoadingScreen";const G=(0,i.Z)(E.Z,{target:"eb7j3e3"})("background-color:",(e=>e.theme.surface200),";"),K=(0,i.Z)("div",{target:"eb7j3e2"})("font-size:32px;line-height:1;padding:",(0,l.Z)(1)," ",(0,l.Z)(3)," ",(0,l.Z)(3)," ",(0,l.Z)(3),";*{text-align:left!important;}"),Q=(0,i.Z)("div",{target:"eb7j3e1"})((e=>e.autoHeightResize&&"height: 100%;")," padding:0 ",(0,l.Z)(3)," ",(0,l.Z)(3),";"),J=(0,i.Z)(f,{target:"eb7j3e0"})("margin-top:",(0,l.Z)(1.5),";border-bottom-left-radius:",(e=>e.theme.borderRadius),";border-bottom-right-radius:",(e=>e.theme.borderRadius),";font-size:",(e=>e.theme.fontSizeMedium),";box-shadow:none;"),$=(0,k.b)(X);var ee=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),te=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/query-string/index.js")),se=s("./app/components/organizations/pageFilters/utils.tsx"),ie=s("./app/stores/groupStore.tsx"),oe=s("./app/stores/memberListStore.tsx"),ae=s("./app/utils/dates.tsx"),re=s("./app/views/issueList/utils.tsx");const ne=re.qh.DATE,de=re.io.EVENTS,le=["filtered"],ce=["owners"];class pe extends o.Component{constructor(...e){super(...e),(0,ee.Z)(this,"state",{loading:!0,errorMessage:void 0,tableResults:[],memberListStoreLoaded:oe.Z.isLoaded(),totalCount:null}),(0,ee.Z)(this,"unlisteners",[oe.Z.listen((()=>{this.setState({memberListStoreLoaded:oe.Z.isLoaded()})}),void 0)])}componentDidMount(){this.fetchData()}componentDidUpdate(e){const{selection:t,widget:s}=this.props,[i]=e.widget.queries.reduce((([e,t],{name:s,...i})=>(e.push(i),t.push(s),[e,t])),[[],[]]),[o]=s.queries.reduce((([e,t],{name:s,...i})=>(e.push(i),t.push(s),[e,t])),[[],[]]);I()(s.displayType,e.widget.displayType)&&I()(s.interval,e.widget.interval)&&I()(o,i)&&I()(s.displayType,e.widget.displayType)&&(0,se.WO)(t,e.selection)||this.fetchData()}componentWillUnmount(){this.unlisteners.forEach((e=>null==e?void 0:e()))}transformTableResults(){const{tableResults:e}=this.state;ie.Z.add(e);const t=[];return e.forEach((e=>{const{id:s,shortId:i,title:o,lifetime:a,...r}=e,n={};Object.keys(r).filter((e=>["number","string"].includes(typeof r[e]))).forEach((e=>{n[e]=r[e]}));const d={...n,id:s,"issue.id":s,issue:i,title:o};a&&(d.lifetimeCount=null==a?void 0:a.count,d.lifetimeUserCount=null==a?void 0:a.userCount),t.push(d)})),t}async fetchIssuesData(){const{selection:e,api:t,organization:s,widget:i}=this.props;this.setState({tableResults:[]});const o=i.queries[0],a="/organizations/".concat(s.slug,"/issues/"),r={project:e.projects,environment:e.environments,query:o.conditions,sort:o.orderby||ne,display:de,collapse:le,expand:ce};e.datetime.period&&(r.statsPeriod=e.datetime.period),e.datetime.end&&(r.end=(0,ae.v5)(e.datetime.end)),e.datetime.start&&(r.start=(0,ae.v5)(e.datetime.start)),e.datetime.utc&&(r.utc=e.datetime.utc);try{var n;const[e,s,i]=await t.requestPromise(a,{includeAllArgs:!0,method:"GET",data:te.stringify({...r,limit:5})});this.setState({loading:!1,errorMessage:void 0,tableResults:e,totalCount:null!==(n=null==i?void 0:i.getResponseHeader("X-Hits"))&&void 0!==n?n:null})}catch(e){var d,l;const t=null!==(d=null==e||null===(l=e.responseJSON)||void 0===l?void 0:l.detail)&&void 0!==d?d:null;this.setState({loading:!1,errorMessage:null!=t?t:(0,R.t)("Unable to load Widget"),tableResults:[]})}}fetchData(){this.setState({loading:!0,errorMessage:void 0}),this.fetchIssuesData()}render(){const{children:e}=this.props,{loading:t,errorMessage:s,memberListStoreLoaded:i}=this.state;return e({loading:t||!i,transformedResults:this.transformTableResults(),errorMessage:s})}}pe.displayName="IssueWidgetQueries";const ue=pe;var he=s("./app/actionCreators/modal.tsx"),ge=s("./app/components/confirm.tsx"),me=s("./app/components/links/link.tsx"),ye=s("./app/components/menuItem.tsx"),be=s("./app/utils/analytics/trackAdvancedAnalyticsEvent.tsx"),ve=s("./app/utils/discover/types.tsx"),fe=s("./app/views/dashboardsV2/utils.tsx"),Ze=s("./app/views/dashboardsV2/widget/utils.tsx"),xe=s("./app/views/dashboardsV2/contextMenu.tsx");function we({organization:e,selection:t,widget:s,widgetLimitReached:i,onDelete:o,onDuplicate:a,onEdit:r,showContextMenu:n,isPreview:d}){function l(){return e.features.includes("connect-discover-and-dashboards")}if(!n)return null;const c=[];if(d)return(0,g.tZ)(_e,{children:(0,g.tZ)(xe.Z,{children:(0,g.tZ)(Se,{children:(0,R.t)("This is a preview only. To edit, you must add this dashboard.")})})});if(("table"===s.displayType||l())&&e.features.includes("discover-basic")&&s.widgetType===z.l9.DISCOVER&&s.queries.length){const i=(0,fe.tT)(s.title,s.queries[0],t,s.displayType),o=i.getResultsViewUrlTarget(e.slug);if(l()){const e=i.getYAxisOptions().map((({value:e})=>e));switch(o.query.yAxis=s.queries[0].fields.filter((t=>e.includes(t))).slice(0,3),s.displayType){case Ze.FO.WORLD_MAP:o.query.display=ve.DC.WORLDMAP;break;case Ze.FO.BAR:o.query.display=ve.DC.BAR;break;case Ze.FO.TOP_N:o.query.display=ve.DC.TOP5}}const a="".concat(o.pathname,"?").concat(te.stringify({...o.query}));1===s.queries.length?c.push((0,g.tZ)(me.Z,{to:a,onClick:()=>{(0,be.Z)("dashboards_views.open_in_discover.opened",{organization:e,widget_type:s.displayType})},children:(0,g.tZ)(Ee,{children:(0,R.t)("Open in Discover")},"open-discover")},"open-discover-link")):c.push((0,g.tZ)(Ee,{onClick:t=>{t.preventDefault(),(0,be.Z)("dashboards_views.query_selector.opened",{organization:e,widget_type:s.displayType}),(0,he.openDashboardWidgetQuerySelectorModal)({organization:e,widget:s})},children:(0,R.t)("Open in Discover")},"open-discover"))}if(s.widgetType===z.l9.ISSUE){var p,u,h,m;const{start:i,end:o,utc:a,period:r}=t.datetime,n=i&&o?{start:(0,ae.v5)(i),end:(0,ae.v5)(o),utc:a}:{statsPeriod:r},d="/organizations/".concat(e.slug,"/issues/?").concat(te.stringify({query:null===(p=s.queries)||void 0===p||null===(u=p[0])||void 0===u?void 0:u.conditions,sort:null===(h=s.queries)||void 0===h||null===(m=h[0])||void 0===m?void 0:m.orderby,...n}));c.push((0,g.tZ)(me.Z,{to:d,children:(0,g.tZ)(Ee,{children:(0,R.t)("Open in Issues")},"open-issues")},"open-issues-link"))}return e.features.includes("dashboards-edit")&&(c.push((0,g.tZ)(Ee,{"data-test-id":"duplicate-widget",onSelect:a,disabled:i,children:(0,R.t)("Duplicate Widget")},"duplicate-widget")),c.push((0,g.tZ)(Ee,{"data-test-id":"edit-widget",onSelect:r,children:(0,R.t)("Edit Widget")},"edit-widget")),c.push((0,g.tZ)(ge.Z,{"data-test-id":"delete-widget",priority:"danger",message:(0,R.t)("Are you sure you want to delete this widget?"),onConfirm:o,children:(0,g.tZ)(Ee,{danger:!0,children:(0,R.t)("Delete Widget")})},"delete-widget"))),c.length?(0,g.tZ)(_e,{children:(0,g.tZ)(xe.Z,{children:c})}):null}we.displayName="WidgetCardContextMenu";const Ce=we,_e=(0,i.Z)("div",{target:"e1yltioa2"})("margin-left:",(0,l.Z)(1),";"),Ee=(0,i.Z)(ye.Z,{target:"e1yltioa1"})("white-space:nowrap;color:",(e=>e.danger?e.theme.red300:e.theme.textColor),";:hover{color:",(e=>e.danger?e.theme.red300:e.theme.textColor),";}"),Se=(0,i.Z)("span",{target:"e1yltioa0"})("padding:",(0,l.Z)(1),";display:block;");s("../node_modules/core-js/modules/es.symbol.description.js");var Re=s("../node_modules/lodash/cloneDeep.js"),De=s.n(Re),Te=s("./app/actionCreators/events.tsx"),je=s("./app/utils/discover/genericDiscoverQuery.tsx");function Me(e,t){var s;return{seriesName:t,data:null!==(s=null==e?void 0:e.data.map((([e,t])=>({name:1e3*e,value:t.reduce(((e,{count:t})=>e+t),0)}))))&&void 0!==s?s:[]}}function ze(e,t){let s=[];const i=e.name;if((0,O.Xe)(t)){const e=Object.keys(t).map((e=>{const s=i?"".concat(i," : ").concat(e):e,o=t[e];return[o.order||0,Me(o,s)]})).sort(((e,t)=>e[0]-t[0])).map((e=>e[1]));s=s.concat(e)}else{const o=e.fields[0],a=i?"".concat(i," : ").concat(o):o,r=Me(t,a);s.push(r)}return s}class Ae extends o.Component{constructor(...e){super(...e),(0,ee.Z)(this,"state",{loading:!0,queryFetchID:void 0,errorMessage:void 0,timeseriesResults:void 0,rawResults:void 0,tableResults:void 0}),(0,ee.Z)(this,"_isMounted",!1)}componentDidMount(){this._isMounted=!0,this.fetchData()}componentDidUpdate(e){var t;const{selection:s,widget:i}=this.props,[o,a]=e.widget.queries.map((e=>(e.fields=e.fields.filter((e=>!!e)),e))).reduce((([e,t],{name:s,...i})=>(e.push(s),t.push(i),[e,t])),[[],[]]),[r,n]=i.queries.map((e=>(e.fields=e.fields.filter((e=>!!e&&"equation|"!==e)),e))).reduce((([e,t],{name:s,...i})=>(e.push(s),t.push(i),[e,t])),[[],[]]);I()(i.displayType,e.widget.displayType)&&I()(i.interval,e.widget.interval)&&I()(n,a)&&I()(i.displayType,e.widget.displayType)&&(0,se.WO)(s,e.selection)?this.state.loading||I()(o,r)||(null===(t=this.state.rawResults)||void 0===t?void 0:t.length)!==i.queries.length||this.setState((e=>{const t=i.queries.reduce(((t,s,i)=>t.concat(ze(s,e.rawResults[i]))),[]);return{...e,timeseriesResults:t}})):this.fetchData()}componentWillUnmount(){this._isMounted=!1}fetchEventData(e){const{selection:t,api:s,organization:i,widget:o}=this.props;let a=[];this.setState({tableResults:[]});const r=o.queries.map((e=>{const a=(0,fe.tT)(o.title,e,t);let r="";const n={per_page:5,noPagination:!0};if("table"===o.displayType)r="/organizations/".concat(i.slug,"/eventsv2/"),n.referrer="api.dashboards.tablewidget";else if("big_number"===o.displayType)r="/organizations/".concat(i.slug,"/eventsv2/"),n.per_page=1,n.referrer="api.dashboards.bignumberwidget";else{if("world_map"!==o.displayType)throw Error("Expected widget displayType to be either big_number, table or world_map");r="/organizations/".concat(i.slug,"/events-geo/"),delete n.per_page,n.referrer="api.dashboards.worldmapwidget"}return(0,je.AA)(s,r,{...a.generateQueryStringObject(),...n})}));let n=0;r.forEach((async(t,s)=>{try{var i,d;const[l]=await t,c=l;if(c.title=null!==(i=null===(d=o.queries[s])||void 0===d?void 0:d.name)&&void 0!==i?i:"",a=[...a,c],!this._isMounted)return;this.setState((t=>t.queryFetchID!==e?t:{...t,tableResults:a}))}catch(e){var l;const t=(null==e||null===(l=e.responseJSON)||void 0===l?void 0:l.detail)||(0,R.t)("An unknown error occurred.");this.setState({errorMessage:t})}finally{if(n++,!this._isMounted)return;this.setState((t=>t.queryFetchID!==e?t:{...t,loading:n!==r.length}))}}))}fetchTimeseriesData(e,t){const{selection:s,api:i,organization:o,widget:a}=this.props;this.setState({timeseriesResults:[],rawResults:[]});const{environments:r,projects:n}=s,{start:d,end:l,period:c}=s.datetime,u=function(e,t){let s="bar"===e.displayType?"1d":e.interval;s||(s="5m");const i=(0,ae.YJ)(s);if((0,O.Nm)(t)/(60*i)>66){const e=(0,O.ZS)(t,"high");if(i<(0,ae.YJ)(e))return e}return s}(a,{start:d,end:l,period:c}),h=a.queries.map((e=>{let s;return"top_n"===a.displayType?(s={organization:o,interval:u,start:d,end:l,project:n,environment:r,period:c,query:e.conditions,yAxis:(0,p.Nk)(e.fields)[0],includePrevious:!1,referrer:"api.dashboards.widget.".concat(t,"-chart"),partial:!0,topEvents:ve.hY,field:e.fields},e.orderby&&(s.orderby=e.orderby)):s={organization:o,interval:u,start:d,end:l,project:n,environment:r,period:c,query:e.conditions,yAxis:e.fields,orderby:e.orderby,includePrevious:!1,referrer:"api.dashboards.widget.".concat(t,"-chart"),partial:!0},(0,Te.lI)(i,s)}));let g=0;h.forEach((async(t,s)=>{try{const i=await t;if(!this._isMounted)return;this.setState((t=>{var o,r;if(t.queryFetchID!==e)return t;const n=[...null!==(o=t.timeseriesResults)&&void 0!==o?o:[]],d=ze(a.queries[s],i);d.forEach(((e,t)=>{n[s*d.length+t]=e}));const l=De()(null!==(r=t.rawResults)&&void 0!==r?r:[]);return l[s]=i,{...t,timeseriesResults:n,rawResults:l}}))}catch(e){var i;const t=(null==e||null===(i=e.responseJSON)||void 0===i?void 0:i.detail)||(0,R.t)("An unknown error occurred.");this.setState({errorMessage:t})}finally{if(g++,!this._isMounted)return;this.setState((t=>t.queryFetchID!==e?t:{...t,loading:g!==h.length}))}}))}fetchData(){const{widget:e}=this.props,t=Symbol("queryFetchID");this.setState({loading:!0,errorMessage:void 0,queryFetchID:t}),["table","world_map","big_number"].includes(e.displayType)?this.fetchEventData(t):this.fetchTimeseriesData(t,e.displayType)}render(){const{children:e}=this.props,{loading:t,timeseriesResults:s,tableResults:i,errorMessage:o}=this.state;return e({loading:t,timeseriesResults:null==s?void 0:s.filter((e=>!!e)),tableResults:i,errorMessage:o})}}Ae.displayName="WidgetQueries";const ke=Ae;class Le extends o.Component{isAllowWidgetsToDiscover(){const{organization:e}=this.props;return e.features.includes("connect-discover-and-dashboards")}renderToolbar(){const{onEdit:e,onDelete:t,draggableProps:s,hideToolbar:i,isEditing:o,hideDragHandle:a}=this.props;return o?(0,g.tZ)(Pe,{children:(0,g.BX)(We,{style:{visibility:i?"hidden":"visible"},children:[!a&&(0,g.tZ)(Be,{children:(0,g.tZ)(Oe,{color:"textColor",className:M.re,...null==s?void 0:s.listeners,...null==s?void 0:s.attributes})}),(0,g.tZ)(Be,{"data-test-id":"widget-edit",onClick:e,children:(0,g.tZ)(S.yl,{color:"textColor"})}),(0,g.tZ)(Be,{"data-test-id":"widget-delete",onClick:t,children:(0,g.tZ)(S.Fz,{color:"textColor"})})]})}):null}renderContextMenu(){const{widget:e,selection:t,organization:s,showContextMenu:i,isPreview:o,widgetLimitReached:a,onEdit:r,onDuplicate:n,onDelete:d}=this.props;return(0,g.tZ)(Ce,{organization:s,widget:e,selection:t,showContextMenu:i,isPreview:o,widgetLimitReached:a,onDuplicate:n,onEdit:r,onDelete:d})}tableResultComponent({loading:e,errorMessage:t,transformedResults:s}){const{location:i,organization:o,widget:a}=this.props;return t?(0,g.tZ)(n.Z,{children:(0,g.tZ)(S.FC,{color:"gray500",size:"lg"})}):e?(0,g.tZ)(He,{height:"200px"}):(0,g.tZ)(Ye,{location:i,title:"",fields:a.queries[0].fields,loading:e,metadata:A.$,data:s,organization:o})}renderIssueChart(){const{widget:e,api:t,organization:s,selection:i,renderErrorMessage:a}=this.props;return(0,g.tZ)(ue,{api:t,organization:s,widget:e,selection:i,children:({transformedResults:e,errorMessage:t,loading:s})=>(0,g.BX)(o.Fragment,{children:["function"==typeof a?a(t):null,(0,g.tZ)(Xe,{loading:s}),this.tableResultComponent({transformedResults:e,loading:s,errorMessage:t}),this.renderToolbar()]})})}renderDiscoverChart(){const{widget:e,api:t,organization:s,selection:i,renderErrorMessage:a,location:r,router:n}=this.props;return(0,g.tZ)(ke,{api:t,organization:s,widget:e,selection:i,children:({tableResults:t,timeseriesResults:d,errorMessage:l,loading:c})=>(0,g.BX)(o.Fragment,{children:["function"==typeof a?a(l):null,(0,g.tZ)($,{timeseriesResults:d,tableResults:t,errorMessage:l,loading:c,location:r,widget:e,selection:i,router:n,organization:s}),this.renderToolbar()]})})}renderChart(){const{widget:e}=this.props;return e.widgetType===z.l9.ISSUE?this.renderIssueChart():this.renderDiscoverChart()}render(){const{widget:e,noLazyLoad:t}=this.props;return(0,g.tZ)(w.Z,{customComponent:(0,g.tZ)(Ne,{children:(0,R.t)("Error loading widget data")}),children:(0,g.BX)(qe,{isDragging:!1,children:[(0,g.BX)(Ue,{children:[(0,g.tZ)(Fe,{children:e.title}),this.renderContextMenu()]}),t?this.renderChart():(0,g.tZ)(a.ZP,{once:!0,resize:!0,height:200,children:this.renderChart()})]})})}}Le.displayName="WidgetCard";const Ie=(0,T.Z)((0,u.Z)((0,j.Z)((0,r.withRouter)(Le)))),Ne=(0,i.Z)(E.Z,{target:"e1fl0u6g10"})("display:flex;align-items:center;justify-content:center;background-color:",(e=>e.theme.alert.error.backgroundLight),";border:1px solid ",(e=>e.theme.alert.error.border),";color:",(e=>e.theme.alert.error.textLight),";border-radius:",(e=>e.theme.borderRadius),";margin-bottom:",(0,l.Z)(2),";"),qe=(0,i.Z)(_.s_,{shouldForwardProp:e=>"isDragging"!==e,target:"e1fl0u6g9"})("margin:0;visibility:",(e=>e.isDragging?"hidden":"visible"),";height:100%;min-height:96px;display:flex;flex-direction:column;"),Pe=(0,i.Z)("div",{target:"e1fl0u6g8"})("position:absolute;top:0;left:0;z-index:auto;width:100%;height:100%;display:flex;justify-content:flex-end;align-items:flex-start;background-color:",(e=>e.theme.overlayBackgroundAlpha),";border-radius:",(e=>e.theme.borderRadius),";"),We=(0,i.Z)("div",{target:"e1fl0u6g7"})("display:flex;margin:10px ",(0,l.Z)(2),";touch-action:none;"),Be=(0,i.Z)("div",{target:"e1fl0u6g6"})("padding:",(0,l.Z)(1),";&:hover{cursor:pointer;}"),Oe=(0,i.Z)(S.LS,{target:"e1fl0u6g5"})({name:"1fhyj3b",styles:"&:hover{cursor:grab;}"}),Fe=(0,i.Z)(Z.Gh,{target:"e1fl0u6g4"})(D.Z,";"),Ue=(0,i.Z)("div",{target:"e1fl0u6g3"})("padding:",(0,l.Z)(2)," ",(0,l.Z)(3)," 0 ",(0,l.Z)(3),";width:100%;display:flex;justify-content:space-between;"),Ve=(0,i.Z)((e=>(0,g.tZ)(x.Z,{...e,maskBackgroundColor:"transparent"})),{target:"e1fl0u6g2"})({name:"1vcob1d",styles:"display:flex;justify-content:center;align-items:center"}),Xe=({loading:e})=>e?(0,g.tZ)(Ve,{visible:e,children:(0,g.tZ)(C.Z,{mini:!0})}):null;Xe.displayName="LoadingScreen";const He=(0,i.Z)(E.Z,{target:"e1fl0u6g1"})("background-color:",(e=>e.theme.surface200),";"),Ye=(0,i.Z)(f,{target:"e1fl0u6g0"})("margin-top:",(0,l.Z)(1.5),";border-bottom-left-radius:",(e=>e.theme.borderRadius),";border-bottom-right-radius:",(e=>e.theme.borderRadius),";font-size:",(e=>e.theme.fontSizeMedium),";box-shadow:none;")}}]);
//# sourceMappingURL=../sourcemaps/app_views_dashboardsV2_dashboard_tsx-app_views_dashboardsV2_widgetCard_index_tsx.78d3695d53f7cfefab2337e303b635bb.js.map