#!/usr/bin/env python3
# This file is placed in the Public Domain.


"OTP-CR-117/19"


import inspect
import os
import readline
import sys
import termios
import time
import traceback


from gcd.evt import Event
from gcd.fnc import format
from gcd.krn import Cfg, boot, kcmd, root
from gcd.obj import Object, update, values
from gcd.prs import parse
from gcd.hdl import Handler
from gcd.tbl import scan
from gcd.tms import tfmt
from gcd.thr import launch


from gcd.mod.irc import IRC
from gcd.mod.irc import Cfg as ICfg
from gcd.mod.rss import Fetcher


import gcd.all
import gcd.mod.all


Cfg.wd = "/var/lib/genocide/"


def watcher(clt, quit=False):
    done = []
    while 1:
        time.sleep(1.0)
        for ex in clt.errors:
            if "reason" in dir(ex) and ex not in done:
                print("\n")
                traceback.print_exception(type(ex), ex, ex.__traceback__)
                if quit:
                    break
            done.append(ex)
        if quit:
            break
    for ex in done:
        clt.errors.remove(ex)


def main():
    print("GENOCIDE start at %s (reconsider OTP-CR-117/19)" % time.ctime(time.time()).replace("  ", " "))
    print("user=%s!%s@%s port=%s channel=%s sasl=%s users=%s" % (ICfg.nick, ICfg.username, ICfg.server, ICfg.port, ICfg.channel, ICfg.sasl, ICfg.users))
    sys.stdout.flush()
    scan()
    i = IRC()
    launch(i.start)
    watcher(i)
    f = Fetcher()
    f.start()
    while 1:
        time.sleep(1.0)
    watcher(f)


main()
