# MIT License
#
# Copyright (c) 2021 Bootcamp contributors
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

image: "tbcp/python:debian"

stages:
  - Installation
  - Linting
  - UnitTesting
  - Building
  - Publishing

# This folder is cached between builds http://docs.gitlab.com/ce/ci/yaml/README.html#cache
cache:
  paths:
    - env

before_script:
  - git config --global user.name "Bootcamp-Project contributors"
  - git config --global user.email "contributors@bootcamp-project.com"
  - make prepare

install:
  stage: Installation
  script: [make install]
  artifacts:
    paths: [.venv]

linting:
  stage: Linting
  script: [make lint]

secure-code:
  stage: Linting
  script: [make secure]

unittests:
  before_script:
    - git clone https://gitlab.com/the-bootcamp-project/packages/gitpy.git tmp/
    - sudo rm -rf .git && sudo cp -r tmp/.git . && sudo rm -rf tmp
    - make prepare
  stage: UnitTesting
  script: [make unittests]

build:
  stage: Building
  script: [make build]
  artifacts:
    paths: [dist]
  only:
    - main

pypi:
  stage: Publishing
  script: [make release]
  only:
    - develop
    - main
